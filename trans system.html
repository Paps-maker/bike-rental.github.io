<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finance Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Place this inside the <head> section of your HTML -->
<link rel="icon" href="img/t1.jpg" type="image/x-icon">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background-color: #f4f6f8; font-family: Arial, sans-serif; }
.navbar, .sidebar { background-color: #0a2e5d; color: #fff; }
.sidebar a { color: #fff; text-decoration: none; display: block; padding: 10px 15px; }
.sidebar a:hover { background-color: #1c3c7a; }
.card { border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
.card-header { background-color: #0a2e5d; color: #ffd700; font-weight: bold; }
.btn-gold { background-color: #ffd700; color: #0a2e5d; }
.btn-gold:hover { background-color: #e6c200; color: #0a2e5d; }
table th, table td { vertical-align: middle !important; cursor:pointer; }
</style>
</head>
<body>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
<div class="modal-dialog modal-sm">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Admin Login</h5></div>
<div class="modal-body">
<form id="loginForm">
<div class="mb-3"><input type="email" id="loginEmail" class="form-control" placeholder="Email" required></div>
<div class="mb-3"><input type="password" id="loginPassword" class="form-control" placeholder="Password" required></div>
<div class="mb-3 text-danger" id="loginError"></div>
<button type="submit" class="w-100 btn btn-gold">Login</button>
</form>
</div>
</div>
</div>
</div>

<nav class="px-4 navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand" href="#">Finance Dashboard</a>
    <button class="ms-auto btn btn-gold" id="logoutBtn" style="display:none;">Logout</button>
</nav>

<div class="container-fluid" id="mainContent" style="display:none;">
<div class="row">
<div class="pt-4 col-md-2 sidebar">
    <a href="#dashboard">Dashboard</a>
    <a href="#transactions">Transactions</a>
</div>

<div class="pt-4 col-md-10">
<!-- Dashboard Cards -->
<div id="dashboard" class="mb-4 row">
    <div class="mb-3 col-md-4">
        <div class="text-center card">
            <div class="card-header">Total Deposits (KSh)</div>
            <div class="card-body"><h3 id="totalDeposits">0</h3></div>
        </div>
    </div>
    <div class="mb-3 col-md-4">
        <div class="text-center card">
            <div class="card-header">Total Withdrawals (KSh)</div>
            <div class="card-body"><h3 id="totalWithdrawals">0</h3></div>
        </div>
    </div>
    <div class="mb-3 col-md-4">
        <div class="text-center card">
            <div class="card-header">Total Transactions</div>
            <div class="card-body"><h3 id="totalTransactions">0</h3></div>
        </div>
    </div>
</div>

<!-- Transactions Section -->
<div id="transactions">
<div class="d-flex justify-content-between mb-2">
    <h4>Transactions <button class="btn btn-gold btn-sm" data-bs-toggle="modal" data-bs-target="#transactionModal">Add Transaction</button></h4>
    <input type="text" id="searchInput" class="w-25 form-control" placeholder="Search by Name or Code">
</div>
<table class="table table-striped mt-2">
<thead class="table-dark">
<tr>
    <th>Customer Name</th>
    <th>ID/Passport</th>
    <th>Phone Number</th>
    <th>Transaction Code</th>
    <th>Type</th>
    <th>Method</th>
    <th>Amount</th>
    <th>Date</th>
    <th>Actions</th>
</tr>
</thead>
<tbody id="transactionTableBody"></tbody>
</table>
</div>

<!-- Charts Section -->
<div class="d-flex mb-2">
    <button class="me-2 btn btn-sm btn-gold" onclick="updateChartView('daily')">Daily</button>
    <button class="me-2 btn btn-sm btn-gold" onclick="updateChartView('weekly')">Weekly</button>
    <button class="btn btn-sm btn-gold" onclick="updateChartView('monthly')">Monthly</button>
</div>
<div class="mb-4 row">
    <div class="mb-3 col-md-6">
        <canvas id="depositWithdrawChart"></canvas>
    </div>
    <div class="mb-3 col-md-6">
        <canvas id="methodPieChart"></canvas>
    </div>
</div>

</div>
</div>
</div>

<!-- Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<form id="transactionForm">
<div class="modal-header">
<h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
    <input type="hidden" id="transactionId">
    <div class="mb-3"><label>Customer Name</label><input type="text" id="customerName" class="form-control" required></div>
    <div class="mb-3"><label>ID/Passport</label><input type="text" id="customerIdNumber" class="form-control" required></div>
    <div class="mb-3"><label>Phone Number</label><input type="text" id="customerPhone" class="form-control" required></div>
    <div class="mb-3"><label>Transaction Code</label><input type="text" id="transactionCode" class="form-control" required></div>
    <div class="mb-3">
        <label>Type</label>
        <select id="transactionType" class="form-control" required>
            <option value="Deposit">Deposit</option>
            <option value="Withdrawal">Withdrawal</option>
        </select>
    </div>
    <div class="mb-3">
        <label>Method</label>
        <select id="transactionMethod" class="form-control" required>
            <option value="MPESA">MPESA</option>
            <option value="Bank">Bank</option>
        </select>
    </div>
    <div class="mb-3"><label>Amount</label><input type="number" id="transactionAmount" class="form-control" required></div>
</div>
<div class="modal-footer"><button type="submit" class="btn btn-gold">Save</button></div>
</form>
</div>
</div>
</div>

<!-- Customer History Modal -->
<div class="modal fade" id="customerHistoryModal" tabindex="-1" aria-labelledby="customerHistoryLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="customerHistoryLabel">Customer Transaction History</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<div class="mb-2 row">
    <div class="col-md-3"><input type="date" id="historyStartDate" class="form-control"></div>
    <div class="col-md-3"><input type="date" id="historyEndDate" class="form-control"></div>
    <div class="col-md-3">
        <select id="historyType" class="form-control">
            <option value="All">All Types</option>
            <option value="Deposit">Deposit</option>
            <option value="Withdrawal">Withdrawal</option>
        </select>
    </div>
    <div class="col-md-3">
        <select id="historyMethod" class="form-control">
            <option value="All">All Methods</option>
            <option value="MPESA">MPESA</option>
            <option value="Bank">Bank</option>
        </select>
    </div>
</div>
<table class="table table-striped">
<thead>
<tr>
    <th>Transaction Code</th>
    <th>Type</th>
    <th>Method</th>
    <th>Amount</th>
    <th>Date</th>
</tr>
</thead>
<tbody id="customerHistoryBody"></tbody>
</table>
<p>Total Deposits: <span id="historyDeposits">0</span> | Total Withdrawals: <span id="historyWithdrawals">0</span></p>
</div>
</div>
</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC0avd1EPsYGw9paeuECB8dd781ZPQBAMI",
  authDomain: "transc-eec4c.firebaseapp.com",
  projectId: "transc-eec4c",
  storageBucket: "transc-eec4c.firebasestorage.app",
  messagingSenderId: "3676403115",
  appId: "1:3676403115:web:cf2291a35c6b8d1e614eee",
  measurementId: "G-QDC9ED0F86"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const transactionTableBody = document.getElementById('transactionTableBody');
const mainContent = document.getElementById('mainContent');
const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
const logoutBtn = document.getElementById('logoutBtn');
let depositWithdrawChart, methodPieChart, chartDataCache=[];

// --- AUTH ---
auth.onAuthStateChanged(user=>{
    if(user){ mainContent.style.display='block'; logoutBtn.style.display='inline-block'; loginModal.hide(); loadTransactions(); }
    else{ mainContent.style.display='none'; logoutBtn.style.display='none'; loginModal.show(); }
});
document.getElementById('loginForm').addEventListener('submit',e=>{
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    auth.signInWithEmailAndPassword(email,password).catch(err=>{ document.getElementById('loginError').innerText = err.message; });
});
logoutBtn.addEventListener('click',()=>{ auth.signOut(); });

// --- TRANSACTIONS ---
function loadTransactions(){
    transactionTableBody.innerHTML='';
    db.collection('transactions').orderBy('date','desc').get().then(snapshot=>{
        let depositTotal=0, withdrawTotal=0;
        let dataArr=[];
        snapshot.forEach(doc=>{
            const data = doc.data();
            dataArr.push({...data,id:doc.id});
            if(data.type==='Deposit') depositTotal+=data.amount;
            if(data.type==='Withdrawal') withdrawTotal+=data.amount;
            const tr = document.createElement('tr');
            tr.innerHTML=`
            <td onclick="showCustomerHistory('${data.customerName}')">${data.customerName}</td>
            <td>${data.customerIdNumber}</td>
            <td>${data.customerPhone}</td>
            <td>${data.transactionCode}</td>
            <td>${data.type}</td>
            <td>${data.method}</td>
            <td>${data.amount.toLocaleString()}</td>
            <td>${new Date(data.date.seconds*1000).toLocaleString()}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editTransaction('${doc.id}','${data.customerName}','${data.customerIdNumber}','${data.customerPhone}','${data.transactionCode}','${data.type}','${data.method}',${data.amount})">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${doc.id}')">Delete</button>
                <button class="btn btn-sm btn-success" onclick="generateReceipt('${doc.id}')">Receipt</button>
            </td>`;
            transactionTableBody.appendChild(tr);
        });
        updateDashboard(depositTotal, withdrawTotal, snapshot.size);
        chartDataCache = dataArr;
        renderCharts(chartDataCache);
    });
}

// --- DASHBOARD ---
function updateDashboard(depositTotal, withdrawTotal, transactionCount){
    document.getElementById('totalDeposits').innerText = depositTotal.toLocaleString();
    document.getElementById('totalWithdrawals').innerText = withdrawTotal.toLocaleString();
    document.getElementById('totalTransactions').innerText = transactionCount;
}

// --- CUSTOMER HISTORY ---
function showCustomerHistory(name){
    document.getElementById('customerHistoryLabel').innerText = `Transaction History: ${name}`;
    loadCustomerHistory(name);
    new bootstrap.Modal(document.getElementById('customerHistoryModal')).show();
}
function loadCustomerHistory(name){
    const tbody = document.getElementById('customerHistoryBody');
    tbody.innerHTML='';
    const startDate = document.getElementById('historyStartDate').value ? new Date(document.getElementById('historyStartDate').value) : null;
    const endDate = document.getElementById('historyEndDate').value ? new Date(document.getElementById('historyEndDate').value) : null;
    const typeFilter = document.getElementById('historyType').value;
    const methodFilter = document.getElementById('historyMethod').value;
    let totalDeposit=0, totalWithdraw=0;
    db.collection('transactions').where('customerName','==',name).orderBy('date','desc').get().then(snapshot=>{
        snapshot.forEach(doc=>{
            const data = doc.data();
            const date = new Date(data.date.seconds*1000);
            if(startDate && date<startDate) return;
            if(endDate && date>endDate) return;
            if(typeFilter!=='All' && data.type!==typeFilter) return;
            if(methodFilter!=='All' && data.method!==methodFilter) return;
            if(data.type==='Deposit') totalDeposit+=data.amount;
            if(data.type==='Withdrawal') totalWithdraw+=data.amount;
            const tr = document.createElement('tr');
            tr.innerHTML=`
            <td>${data.transactionCode}</td>
            <td>${data.type}</td>
            <td>${data.method}</td>
            <td>${data.amount.toLocaleString()}</td>
            <td>${date.toLocaleString()}</td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('historyDeposits').innerText = totalDeposit.toLocaleString();
        document.getElementById('historyWithdrawals').innerText = totalWithdraw.toLocaleString();
    });
}

// --- ADD/EDIT/DELETE TRANSACTION with Transaction Code as Primary Key ---
document.getElementById('transactionForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const id = document.getElementById('transactionId').value;
    const transactionCode = document.getElementById('transactionCode').value.trim();

    // Check for duplicate transaction code
    const codeQuery = await db.collection('transactions').where('transactionCode','==',transactionCode).get();
    if(!id && !codeQuery.empty){ alert('Transaction Code already exists!'); return; }
    if(id && !codeQuery.empty && codeQuery.docs[0].id !== id){ alert('Transaction Code exists for another transaction!'); return; }

    const data = {
        customerName: document.getElementById('customerName').value,
        customerIdNumber: document.getElementById('customerIdNumber').value,
        customerPhone: document.getElementById('customerPhone').value,
        transactionCode,
        type: document.getElementById('transactionType').value,
        method: document.getElementById('transactionMethod').value,
        amount: parseFloat(document.getElementById('transactionAmount').value),
        date: firebase.firestore.Timestamp.now()
    };

    if(id){
        await db.collection('transactions').doc(id).update(data);
        loadTransactions();
        new bootstrap.Modal(document.getElementById('transactionModal')).hide();
        document.getElementById('transactionForm').reset();
        document.getElementById('transactionId').value='';
    } else {
        await db.collection('transactions').add(data);
        loadTransactions();
        document.getElementById('transactionForm').reset();
    }
});

function editTransaction(id,name,idNumber,phone,code,type,method,amount){
    document.getElementById('transactionId').value=id;
    document.getElementById('customerName').value=name;
    document.getElementById('customerIdNumber').value=idNumber;
    document.getElementById('customerPhone').value=phone;
    document.getElementById('transactionCode').value=code;
    document.getElementById('transactionType').value=type;
    document.getElementById('transactionMethod').value=method;
    document.getElementById('transactionAmount').value=amount;
    new bootstrap.Modal(document.getElementById('transactionModal')).show();
}

function deleteTransaction(id){ if(confirm('Are you sure you want to delete this transaction?')) db.collection('transactions').doc(id).delete().then(()=>loadTransactions()); }

// --- RECEIPT ---
function generateReceipt(id){
    db.collection('transactions').doc(id).get().then(doc=>{
        const data = doc.data();
        const { jsPDF } = window.jspdf;
        const docPDF = new jsPDF();
        docPDF.text("Transaction Receipt",20,20);
        docPDF.text(`Customer: ${data.customerName}`,20,30);
        docPDF.text(`ID/Passport: ${data.customerIdNumber}`,20,40);
        docPDF.text(`Phone: ${data.customerPhone}`,20,50);
        docPDF.text(`Transaction Code: ${data.transactionCode}`,20,60);
        docPDF.text(`Type: ${data.type}`,20,70);
        docPDF.text(`Method: ${data.method}`,20,80);
        docPDF.text(`Amount: ${data.amount.toLocaleString()}`,20,90);
        docPDF.text(`Date: ${new Date(data.date.seconds*1000).toLocaleString()}`,20,100);
        docPDF.save(`${data.transactionCode}_receipt.pdf`);
    });
}

// --- SEARCH ---
document.getElementById('searchInput').addEventListener('input', e=>{
    const val = e.target.value.toLowerCase();
    transactionTableBody.querySelectorAll('tr').forEach(tr=>{
        const name = tr.children[0].innerText.toLowerCase();
        const code = tr.children[3].innerText.toLowerCase();
        tr.style.display=(name.includes(val) || code.includes(val))?'':'none';
    });
});

// --- CHARTS ---
function renderCharts(dataArr){
    const labels = dataArr.map(d=>new Date(d.date.seconds*1000).toLocaleDateString());
    const deposits = dataArr.map(d=>d.type==='Deposit'?d.amount:0);
    const withdrawals = dataArr.map(d=>d.type==='Withdrawal'?d.amount:0);
    if(depositWithdrawChart) depositWithdrawChart.destroy();
    depositWithdrawChart = new Chart(document.getElementById('depositWithdrawChart'),{
        type:'bar',
        data:{ labels, datasets:[ { label:'Deposits', data:deposits, backgroundColor:'#0a2e5d' }, { label:'Withdrawals', data:withdrawals, backgroundColor:'#ffd700' } ] },
        options:{ responsive:true, plugins:{legend:{position:'top'}} }
    });

    const mpesa = dataArr.filter(d=>d.method==='MPESA').length;
    const bank = dataArr.filter(d=>d.method==='Bank').length;
    if(methodPieChart) methodPieChart.destroy();
    methodPieChart = new Chart(document.getElementById('methodPieChart'),{
        type:'pie',
        data:{ labels:['MPESA','Bank'], datasets:[{data:[mpesa,bank],backgroundColor:['#0a2e5d','#ffd700'] }] },
        options:{ responsive:true }
    });
}

function updateChartView(view){
    // For simplicity, this example keeps daily view; you can implement weekly/monthly aggregation here
    renderCharts(chartDataCache); 
}
</script>
</body>
</html>
