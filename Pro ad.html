<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RidePro ‚Äî Admin (Vehicles & Simulator)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
   <link rel="icon" type="image/png" href="img/admin.jpg">
  <style>
    :root{ --bg:#071025; --panel:#071829; --accent:#c79a2f; --muted:#9fb3c8 }
    body{background:linear-gradient(180deg,#06121a,#04121a); color:#e7eef6; padding:18px; font-family:Inter,system-ui,Arial}
    .panel{background:var(--panel); border-radius:10px; padding:14px}
    .muted{color:var(--muted)}
    #mapAdmin{height:400px;border-radius:10px}
    .driver-img{width:48px;height:48px;border-radius:8px;object-fit:cover}
    .status-badge{padding:.35rem .6rem; border-radius:6px; font-weight:600}
    .btn-gold{background:var(--accent);border-color:var(--accent);color:#081019}
    .stat-card{background:rgba(255,255,255,0.02); border-radius:8px; padding:10px}
    .badge-available{background:#2ecc71;color:#04210b}
    .badge-busy{background:#f39c12;color:#2a1a00}
    .badge-offline{background:#95a5a6;color:#04210b}
    @media (max-width:991px){ #mapAdmin{height:260px} }
    .small-muted{color:var(--muted)}
  </style>
</head>
<!-- üîä Ride Request Alert (Loud & Continuous) -->
<audio id="rideSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<!-- üîá Sound Toggle Button -->
<div style="position: fixed; top: 10px; right: 10px; z-index: 9999;">
  <button id="toggleSound" class="btn btn-sm btn-secondary">üîä Sound On</button>
</div>
<body>
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-0">RidePro ‚Äî Admin (Vehicles)</h3>
        <div class="muted small">Manage vehicles, monitor bookings, simulate live driver positions</div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <div class="me-2 text-center stat-card">
          <div class="small-muted">Active Vehicles</div><div id="counterVehicles" class="h5">0</div>
        </div>
        <div class="me-2 text-center stat-card">
          <div class="small-muted">Active Rides</div><div id="counterRides" class="h5">0</div>
        </div>
        <div class="me-2 text-center stat-card">
          <div class="small-muted">Completed</div><div id="counterCompleted" class="h5">0</div>
        </div>
        <button id="btnAddVehicle" class="btn btn-gold btn-sm">Add Vehicle</button>
        <button id="btnStartSim" class="btn-outline-light btn btn-sm">Start Simulation</button>
        <button id="btnStopSim" class="btn-outline-danger btn btn-sm d-none">Stop Simulation</button>
      </div>
    </div>

    <div class="mb-3 row g-3">
      <div class="col-lg-8">
        <div class="mb-3 panel">
          <h6>Vehicles & Rides Map</h6>
          <div id="mapAdmin"></div>
        </div>

       <div class="mb-3 panel">
  <h6>Incoming / Active Rides</h6>
  <div id="ridesList" class="list-group mt-2" style="max-height:260px;overflow:auto">
    <div class="py-3 text-muted text-center">No rides yet...</div>
  </div>
</div>


        <div class="panel">
          <h6>Vehicles List</h6>
          <div id="vehiclesList" class="list-group mt-2" style="max-height:220px;overflow:auto"></div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="mb-3 panel">
          <h6>Quick</h6>
          <div class="gap-2 d-grid">
            <button id="btnReload" class="btn-outline-light btn btn-sm">Reload List</button>
            <div class="small-muted">Simulation updates vehicle.latitude & vehicle.longitude fields</div>
          </div>
        </div>

        <div class="mb-3 panel">
          <h6>Add Vehicle (quick)</h6>
          <div class="mb-2">
            <input id="quickName" class="mb-2 form-control form-control-sm" placeholder="Vehicle name (Taxi 01)">
            <select id="quickType" class="mb-2 form-select-sm form-select">
              <option value="car">Car</option><option value="premium">Premium</option><option value="bike">Bike</option><option value="van">Van</option>
            </select>
            <input id="quickImage" class="mb-2 form-control form-control-sm" placeholder="Image URL (optional)">
            <button id="btnQuickAdd" class="btn btn-sm btn-gold">Add vehicle</button>
          </div>
        </div>

        <div class="panel">
          <h6>Loyalty Summary</h6>
          <div class="small-muted">Points are awarded when rides are completed.</div>
          <div class="mt-2"><strong>Total loyalty entries:</strong> <span id="totalLoyalty">0</span></div>
          <div class="mt-2"><strong>Top customers</strong>
            <ul id="topCustomers" class="mt-2 small"></ul>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- vehicle modal -->
  <div class="modal fade" id="vehicleModal" tabindex="-1"><div class="modal-dialog"><form id="vehicleForm" class="modal-content"><div class="modal-header"><h5 class="modal-title">Add / Edit Vehicle</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <input id="vehicleId" type="hidden">
    <label class="small-muted">Name</label>
    <input id="vName" class="mb-2 form-control">
    <label class="small-muted">Type</label>
    <select id="vType" class="mb-2 form-select"><option value="car">Car</option><option value="premium">Premium</option><option value="bike">Bike</option><option value="van">Van</option></select>
    <label class="small-muted">Status</label>
    <select id="vStatus" class="mb-2 form-select"><option value="available">available</option><option value="busy">busy</option><option value="offline">offline</option></select>
    <label class="small-muted">Image (URL or upload)</label>
    <input id="vImageUrl" class="mb-2 form-control" placeholder="https://...">
    <input id="vImageFile" type="file" class="mb-2 form-control">
    <label class="small-muted">Latitude (optional)</label>
    <input id="vLat" class="mb-2 form-control" placeholder="-1.286">
    <label class="small-muted">Longitude (optional)</label>
    <input id="vLng" class="mb-2 form-control" placeholder="36.817">
  </div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" type="submit">Save</button></div></form></div></div>

  <!-- assign modal (pick vehicle to assign) -->
  <div class="modal fade" id="assignModal" tabindex="-1"><div class="modal-dialog"><form id="assignForm" class="modal-content"><div class="modal-header"><h5 class="modal-title">Assign Vehicle</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <input id="assignRideId" type="hidden">
    <label class="small-muted">Choose vehicle</label>
    <select id="assignVehicleSelect" class="mb-2 form-select"></select>
    <div class="small-muted">Selecting a vehicle will set ride.status = "accepted" and vehicle.status = "busy".</div>
  </div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" type="submit">Assign</button></div></form></div></div>

  <!-- receipt modal -->
  <div class="modal fade" id="receiptModal" tabindex="-1"><div class="modal-dialog modal-md"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Receipt</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="receiptBody"></div><div class="modal-footer"><button id="printReceipt" class="btn-outline-light btn btn-sm">Print</button><button id="downloadReceipt" class="btn btn-gold btn btn-sm">Download</button></div></div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY_HERE&libraries=places"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, getDocs, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ---------------- Firebase config ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyC0avd1EPsYGw9paeuECB8dd781ZPQBAMI",
  authDomain: "transc-eec4c.firebaseapp.com",
  projectId: "transc-eec4c",
  storageBucket: "transc-eec4c.firebasestorage.app",
  messagingSenderId: "3676403115",
  appId: "1:3676403115:web:4da31c41de4b990b614eee",
  measurementId: "G-R29NT412SJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/firebase-messaging-sw.js')
    .then(reg => console.log('Service Worker registered:', reg))
    .catch(err => console.error('SW registration failed:', err));
}
const messaging = getMessaging(app);

Notification.requestPermission().then(permission => {
  if (permission === 'granted') {
    console.log('Notification permission granted.');
    getToken(messaging, {
      vapidKey: 'BMHq0uN0pS8LZyqaphCho2D9TLrDs-gPpY-p-9SFoafX1QbwlF71hw83pEY_DQoP5AD633nt0O6tOtG0GgWiVQ0'
    }).then(currentToken => {
      if (currentToken) {
        console.log('FCM Token:', currentToken);
        // ‚úÖ Optionally save this token to Firestore for sending messages later
      } else {
        console.warn('No registration token available.');
      }
    });
  } else {
    console.warn('Notification permission denied.');
  }
});


    // UI refs
    const vehiclesList = document.getElementById('vehiclesList');
    const ridesList = document.getElementById('ridesList');
    const counterVehicles = document.getElementById('counterVehicles');
    const counterRides = document.getElementById('counterRides');
    const counterCompleted = document.getElementById('counterCompleted');
    const totalLoyaltyEl = document.getElementById('totalLoyalty');
    const topCustomersEl = document.getElementById('topCustomers');

    const mapDiv = document.getElementById('mapAdmin');
    const btnAddVehicle = document.getElementById('btnAddVehicle');
    const vehicleModalEl = document.getElementById('vehicleModal');
    const vehicleModal = new bootstrap.Modal(vehicleModalEl);
    const vehicleForm = document.getElementById('vehicleForm');

    const assignModal = new bootstrap.Modal(document.getElementById('assignModal'));
    const assignForm = document.getElementById('assignForm');
    const assignVehicleSelect = document.getElementById('assignVehicleSelect');

    const quickName = document.getElementById('quickName');
    const quickType = document.getElementById('quickType');
    const quickImage = document.getElementById('quickImage');

    const btnQuickAdd = document.getElementById('btnQuickAdd');
    const btnStartSim = document.getElementById('btnStartSim');
    const btnStopSim = document.getElementById('btnStopSim');
    const btnReload = document.getElementById('btnReload');

    // map + markers
    let map, geocoder;
    let vehicleMarkers = {}; // vehicleId -> marker
    let rideMarkers = {}; // rideId -> { pickupMarker, destMarker, polyline(optional) }

    function initMap(){
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(mapDiv, { center:{lat:-1.286389,lng:36.817223}, zoom:12 });
    }
    if (window.google && window.google.maps) initMap();

    // Realtime watchers
    let vehiclesUnsub = null;
    let ridesUnsub = null;
    let paymentsUnsub = null;
    let loyaltyUnsub = null;

    function startRealtime(){
      // Vehicles
      vehiclesUnsub = onSnapshot(collection(db,'vehicles'), snap => {
        const list = [];
        snap.forEach(d => list.push({ id: d.id, ...d.data() }));
        renderVehicles(list);
        plotVehicles(list);
        counterVehicles.textContent = list.length;
      });

      // Rides
      ridesUnsub = onSnapshot(collection(db,'rides', ), snap => {
        const list = [];
        snap.forEach(d => list.push({ id: d.id, ...d.data() }));
        // sort by requestedAt desc
        list.sort((a,b)=> new Date(b.requestedAt) - new Date(a.requestedAt));
        renderRides(list);
        plotRides(list);
        const active = list.filter(r => r.status === 'requested' || r.status === 'accepted' || r.status === 'ongoing').length;
        const completed = list.filter(r => r.status === 'completed').length;
        counterRides.textContent = active;
        counterCompleted.textContent = completed;
      });

      // Payments (for receipts)
      paymentsUnsub = onSnapshot(collection(db,'payments'), snap => {
        // no UI list here, but could be added
      });

      // Loyalty summary
      loyaltyUnsub = onSnapshot(collection(db,'loyalty'), snap => {
        totalLoyaltyEl.textContent = snap.size;
        // aggregate by phone/customer
        const agg = {};
        snap.forEach(d => {
          const data = d.data();
          const key = data.phone || data.customer || 'Guest';
          agg[key] = (agg[key]||0) + (data.points || 0);
        });
        // show top 5
        const arr = Object.entries(agg).sort((a,b)=> b[1]-a[1]).slice(0,5);
        topCustomersEl.innerHTML = '';
        arr.forEach(([k,v])=>{
          const li = document.createElement('li'); li.className='small';
          li.textContent = `${k} ‚Äî ${v} pts`; topCustomersEl.appendChild(li);
        });
      });
    }
    startRealtime();

    // --- Render Vehicles list ---
    function renderVehicles(list){
      vehiclesList.innerHTML = '';
      list.forEach(v => {
        const el = document.createElement('div');
        el.className = 'list-group-item bg-transparent d-flex justify-content-between align-items-center';
        const img = v.image || '';
        const statusBadge = v.status === 'available' ? 'badge-available' : v.status === 'busy' ? 'badge-busy' : 'badge-offline';
        el.innerHTML = `<div class="d-flex align-items-center gap-3">
            ${img ? `<img src="${escapeHtml(img)}" class="driver-img">` : ''}
            <div>
              <div class="fw-bold">${escapeHtml(v.name)}</div>
              <div class="muted small">${escapeHtml(v.type)} ‚Ä¢ <span class="${statusBadge} status-badge">${escapeHtml(v.status||'unknown')}</span></div>
            </div>
          </div>
          <div>
            <button class="btn-outline-light btn btn-sm btn-edit" data-id="${v.id}">Edit</button>
            <button class="btn-outline-danger btn btn-sm btn-del" data-id="${v.id}">Delete</button>
            <button class="btn-outline-primary btn btn-sm btn-teleport" data-id="${v.id}">Teleport</button>
          </div>`;
        vehiclesList.appendChild(el);
      });

      document.querySelectorAll('.btn-edit').forEach(b => b.onclick = ()=> editVehicle(b.dataset.id));
      document.querySelectorAll('.btn-del').forEach(b => b.onclick = async ()=> {
        if (!confirm('Delete vehicle?')) return;
        await deleteDoc(doc(db,'vehicles', b.dataset.id));
      });
      document.querySelectorAll('.btn-teleport').forEach(b => b.onclick = ()=> teleportVehicle(b.dataset.id));
    }

    // --- Plot vehicles on map ---
    function plotVehicles(list){
      // remove markers that no longer exist
      const existingIds = new Set(list.map(x=>x.id));
      for (const id of Object.keys(vehicleMarkers)){
        if (!existingIds.has(id)){ vehicleMarkers[id].setMap(null); delete vehicleMarkers[id]; }
      }
      list.forEach(v=>{
        if (typeof v.latitude === 'number' && typeof v.longitude === 'number'){
          const pos = { lat: v.latitude, lng: v.longitude };
          if (vehicleMarkers[v.id]){
            vehicleMarkers[v.id].setPosition(pos);
            vehicleMarkers[v.id].setTitle(v.name);
            // optionally change icon color based on status
            const icon = vehicleMarkers[v.id].getIcon ? vehicleMarkers[v.id].getIcon() : null;
            // no heavy icon update here to keep it simple
          } else {
            const icon = {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 9,
              fillColor: (v.status==='available'?'#2ecc71': v.status==='busy'?'#f39c12':'#95a5a6'),
              fillOpacity: 1,
              strokeColor: '#081019',
              strokeWeight: 1
            };
            const m = new google.maps.Marker({ position: pos, map, title: v.name, icon });
            const inf = new google.maps.InfoWindow({
              content: `<div style="min-width:160px"><strong>${escapeHtml(v.name)}</strong><div>${escapeHtml(v.type)} ‚Ä¢ ${escapeHtml(v.status)}</div>${v.image?`<div style="margin-top:6px"><img src="${escapeHtml(v.image)}" style="width:100%"></div>`:''}</div>`
            });
            m.addListener('click', ()=> inf.open(map,m));
            vehicleMarkers[v.id] = m;
          }
        } else {
          // vehicle has no coords ‚Äî hide marker if exists
          if (vehicleMarkers[v.id]){ vehicleMarkers[v.id].setMap(null); delete vehicleMarkers[v.id]; }
        }
      });
    }

  // --- Rides UI ---
function renderRides(list) {
  ridesList.innerHTML = '';

  list.forEach(r => {
    const el = document.createElement('div');
    el.className =
      'list-group-item bg-transparent d-flex justify-content-between align-items-start border rounded mb-2 p-2 text-light';

    const statusBadge =
      r.status === 'requested'
        ? '<span class="bg-warning text-dark badge">Requested</span>'
        : r.status === 'accepted'
        ? '<span class="bg-info text-dark badge">Accepted</span>'
        : r.status === 'ongoing'
        ? '<span class="bg-primary text-white badge">Ongoing</span>'
        : r.status === 'completed'
        ? '<span class="bg-success text-white badge">Completed</span>'
        : '<span class="bg-secondary text-white badge">Unknown</span>';

    const assignedVehicle =
      r.vehicleId
        ? `<div class="opacity-75 mt-1 text-light small">üöó Vehicle Name: ${escapeHtml(r.assignedVehicleName || '')}</div>`
        : '';

    const assignedVehicleType =
      r.vehicleType
        ? `<div class="opacity-75 mt-1 text-light small">üöò Vehicle Type: ${escapeHtml(r.vehicleType || '')}</div>`
        : '';

    const driverName = r.assignedDriverName || r.driverName || r.driverFullName || r.driver || '';
    const assignedDriver = driverName
      ? `<div class="opacity-75 mt-1 text-light small">üßç‚Äç‚ôÇÔ∏è Driver: ${escapeHtml(driverName)}</div>`
      : `<div class="opacity-75 mt-1 text-warning small">üßç‚Äç‚ôÇÔ∏è Driver: Not yet assigned</div>`;

    el.innerHTML = `
      <div>
        <div class="text-warning fw-bold">${escapeHtml(r.pickup)} ‚Üí ${escapeHtml(r.destination)}</div>
        <div class="mt-1 small" style="color:#f0f0f0;">
          <i class="text-info bi bi-person-fill"></i> ${escapeHtml(r.customerName || 'Guest')} <br>
          <i class="text-info bi bi-telephone"></i> ${escapeHtml(r.customerPhone || 'N/A')} <br>
          <i class="text-danger bi bi-geo-alt"></i> Pickup: <span class="text-white">${escapeHtml(r.pickup)}</span><br>
          <i class="text-success bi bi-flag-fill"></i> Destination: <span class="text-white">${escapeHtml(r.destination)}</span><br>
          <i class="text-warning bi bi-clock"></i> <span class="text-white">${new Date(r.requestedAt).toLocaleString()}</span>
        </div>
        ${assignedVehicle}
        ${assignedVehicleType}
        ${assignedDriver}
        <div class="mt-2 text-success small fw-semibold">
          üí∞ Fare: <span class="text-light">KSh ${Number(r.estimate?.fare || 0).toLocaleString()}</span>
        </div>
      </div>

      <div class="text-end">
        ${statusBadge}
        <div class="d-flex flex-column mt-2">
          ${r.status === 'requested' ? `<button class="mb-1 btn btn-sm btn-success btn-assign" data-id="${r.id}">Assign</button>` : ''}
          ${r.status === 'accepted' ? `<button class="mb-1 btn btn-sm btn-primary btn-start" data-id="${r.id}">Start</button>` : ''}
          ${r.status === 'ongoing' ? `<button class="mb-1 btn btn-sm btn-success btn-complete" data-id="${r.id}">Complete</button>` : ''}
          <button class="mt-1 btn-outline-danger btn btn-sm btn-cancel" data-id="${r.id}">Cancel</button>
          <button class="mt-1 btn btn-sm btn-danger btn-delete" data-id="${r.id}">Delete</button>
        </div>
      </div>
    `;

    ridesList.appendChild(el);
  });

  // --- Button event handlers ---
  document.querySelectorAll('.btn-assign').forEach(b => (b.onclick = () => openAssignModal(b.dataset.id)));
  document.querySelectorAll('.btn-start').forEach(b => (b.onclick = () => startRide(b.dataset.id)));
  document.querySelectorAll('.btn-complete').forEach(b => (b.onclick = () => completeRide(b.dataset.id)));
  document.querySelectorAll('.btn-cancel').forEach(b => (b.onclick = () => cancelRide(b.dataset.id)));

  // --- Delete ride ---
  document.querySelectorAll('.btn-delete').forEach(b => {
    b.onclick = async () => {
      if (!confirm('Are you sure you want to permanently delete this ride?')) return;
      try {
        const rideRef = doc(db, 'rides', b.dataset.id);
        await deleteDoc(rideRef);
        alert('Ride deleted successfully.');
      } catch (err) {
        console.error(err);
        alert('Failed to delete ride.');
      }
    };
  });
}

// ============================================================
// üîî RIDE ALERT SYSTEM
// ============================================================
let alertInterval = null;
let currentBeepingRideId = null;

// --- Function: Start Beeping for new ride ---
function startBeeping(rideId) {
  if (alertInterval) clearInterval(alertInterval);
  currentBeepingRideId = rideId;

  const audio = document.getElementById("rideSound");
  

  alertInterval = setInterval(() => {
    audio.currentTime = 0;
    audio.volume = 1.0;
    audio.play().catch(() => {});
    if (navigator.vibrate) navigator.vibrate([400, 200, 400]);
  }, 2000);
}

// --- Function: Stop Beeping ---
function stopBeeping() {
  if (alertInterval) clearInterval(alertInterval);
  currentBeepingRideId = null;
  const audio = document.getElementById("rideSound");
  audio.pause();
  audio.currentTime = 0;
  navigator.vibrate(0);
}

// --- Realtime Firebase Listener for New Rides ---
let previousRides = new Set();

onSnapshot(collection(db, "rides"), (snap) => {
  const rides = [];
  snap.forEach((s) => rides.push({ id: s.id, ...s.data() }));
  rides.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));

  // Detect new ride requests
  rides.forEach((r) => {
    const isNew = !previousRides.has(r.id);
    if (isNew && r.status === "requested") {
      startBeeping(r.id);
    }

    // Stop beeping if ride was marked/changed
    if (currentBeepingRideId === r.id && r.status !== "requested") {
      stopBeeping();
    }
  });

  previousRides = new Set(rides.map((r) => r.id));
  renderRides(rides);
});

// --- Stop beeping when user clicks action buttons ---
document.addEventListener("click", (e) => {
  if (
    e.target &&
    (e.target.classList.contains("btn-assign") ||
     e.target.classList.contains("btn-start") ||
     e.target.classList.contains("btn-complete") ||
     e.target.classList.contains("btn-cancel"))
  ) {
    stopBeeping();
  }
});


    // --- Plot rides on map (pickup/destination markers) ---
    function plotRides(list){
      // remove markers for rides no longer present
      const existing = new Set(list.map(x=>x.id));
      for (const id of Object.keys(rideMarkers)){
        if (!existing.has(id)){
          const rm = rideMarkers[id];
          if (rm.pickupMarker) rm.pickupMarker.setMap(null);
          if (rm.destMarker) rm.destMarker.setMap(null);
          if (rm.polyline) rm.polyline.setMap(null);
          delete rideMarkers[id];
        }
      }

      list.forEach(r=>{
        // create markers if coordinates stored in ride doc (prefer lat/lng in ride doc to avoid geocode)
        if (r.pickupLat && r.pickupLng && r.destLat && r.destLng){
          const pickupPos = { lat: r.pickupLat, lng: r.pickupLng };
          const destPos = { lat: r.destLat, lng: r.destLng };
          if (rideMarkers[r.id]){
            rideMarkers[r.id].pickupMarker.setPosition(pickupPos);
            rideMarkers[r.id].destMarker.setPosition(destPos);
          } else {
            const p = new google.maps.Marker({ position: pickupPos, map, title: 'Pickup: ' + (r.pickup||''), label: { text: 'P', color: '#fff' } });
            const d = new google.maps.Marker({ position: destPos, map, title: 'Destination: ' + (r.destination||''), label: { text: 'D', color: '#fff' } });
            // optional polyline
            const poly = new google.maps.Polyline({ path:[pickupPos,destPos], strokeColor:'#007bff', strokeOpacity:0.6, strokeWeight:3, map });
            rideMarkers[r.id] = { pickupMarker: p, destMarker: d, polyline: poly };
            // info windows
            const iw = new google.maps.InfoWindow({ content: `<div><strong>${escapeHtml(r.customerName||r.customerPhone||'Guest')}</strong><div>${escapeHtml(r.pickup)} ‚Üí ${escapeHtml(r.destination)}</div></div>`});
            p.addListener('click', ()=> iw.open(map,p));
            d.addListener('click', ()=> iw.open(map,d));
          }
        } else {
          // if ride lacks lat/lng, try lightweight geocode for pickup & dest once and store into ride doc for future plotting
          if (!r._geocoded) geocodeAndStoreRideCoords(r);
        }
      });
    }

    // geocode and update ride document with coordinates (only once)
    async function geocodeAndStoreRideCoords(r){
      try {
        // geocode pickup
        const pu = await geocodeAddress(r.pickup);
        const de = await geocodeAddress(r.destination);
        if (pu && de){
          await updateDoc(doc(db,'rides', r.id), { pickupLat: pu.lat, pickupLng: pu.lng, destLat: de.lat, destLng: de.lng });
        }
      } catch(e){ console.warn('geocode failed', e); }
    }

    function geocodeAddress(text){
      return new Promise((resolve,reject)=>{
        geocoder.geocode({ address: text }, (results, status) => {
          if (status === 'OK' && results[0]) {
            resolve({ lat: results[0].geometry.location.lat(), lng: results[0].geometry.location.lng() });
          } else {
            resolve(null);
          }
        });
      });
    }

    // --- Quick Add ---
    btnQuickAdd.onclick = async ()=>{
      const name = quickName.value.trim(); if (!name) return alert('Enter name');
      const img = quickImage.value.trim() || null;
      await addDoc(collection(db,'vehicles'), { name, type: quickType.value, image: img, status: 'available', createdAt: new Date().toISOString() });
      quickName.value=''; quickImage.value='';
    };

    // --- Vehicle modal (Add/Edit) ---
    btnAddVehicle.onclick = ()=> {
      document.getElementById('vehicleForm').reset();
      document.getElementById('vehicleId').value = '';
      vehicleModal.show();
    };

    vehicleForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = document.getElementById('vehicleId').value || null;
      const name = document.getElementById('vName').value.trim();
      const type = document.getElementById('vType').value;
      const status = document.getElementById('vStatus').value;
      const url = document.getElementById('vImageUrl').value.trim();
      const file = document.getElementById('vImageFile').files[0];
      const lat = parseFloat(document.getElementById('vLat').value) || null;
      const lng = parseFloat(document.getElementById('vLng').value) || null;
      let imageURL = url || null;
      if (file){
        const ref = sRef(storage, `vehicles/${Date.now()}_${file.name}`);
        await uploadBytes(ref, file);
        imageURL = await getDownloadURL(ref);
      }
      const data = { name, type, status, image: imageURL, updatedAt: new Date().toISOString() };
      if (typeof lat === 'number' && typeof lng === 'number'){ data.latitude = lat; data.longitude = lng; }
      if (id) await updateDoc(doc(db,'vehicles', id), data); else await addDoc(collection(db,'vehicles'), data);
      vehicleModal.hide();
    });

    async function editVehicle(id){
      const ds = await getDoc(doc(db,'vehicles', id));
      if (!ds.exists()) return alert('Not found');
      const d = ds.data();
      document.getElementById('vehicleId').value = id;
      document.getElementById('vName').value = d.name || '';
      document.getElementById('vType').value = d.type || 'car';
      document.getElementById('vStatus').value = d.status || 'available';
      document.getElementById('vImageUrl').value = d.image || '';
      document.getElementById('vLat').value = d.latitude || '';
      document.getElementById('vLng').value = d.longitude || '';
      vehicleModal.show();
    }

    // teleport
    async function teleportVehicle(id){
      const center = { lat:-1.286389, lng:36.817223 };
      const lat = center.lat + (Math.random()-0.5)*0.06;
      const lng = center.lng + (Math.random()-0.5)*0.06;
      await updateDoc(doc(db,'vehicles', id), { latitude: lat, longitude: lng, updatedAt: new Date().toISOString() });
      alert('Teleported vehicle to new random position');
    }

    // Simulation (same as before)
    let simInterval = null;
    btnStartSim.onclick = () => {
      if (simInterval) return;
      simInterval = setInterval(simulateStep, 3500);
      btnStartSim.classList.add('d-none'); btnStopSim.classList.remove('d-none');
      alert('Simulation started ‚Äî vehicles will move every 3.5s');
    };
    btnStopSim.onclick = () => {
      if (!simInterval) return;
      clearInterval(simInterval); simInterval = null;
      btnStartSim.classList.remove('d-none'); btnStopSim.classList.add('d-none');
      alert('Simulation stopped');
    };

    async function simulateStep(){
      const snap = await getDocs(collection(db,'vehicles'));
      const center = { lat:-1.286389, lng:36.817223 };
      const updates = [];
      snap.forEach(d => {
        const v = { id: d.id, ...d.data() };
        if (v.status === 'offline') return;
        let lat = (typeof v.latitude === 'number') ? v.latitude : center.lat + (Math.random()-0.5)*0.03;
        let lng = (typeof v.longitude === 'number') ? v.longitude : center.lng + (Math.random()-0.5)*0.03;
        lat += (Math.random()-0.5)*0.0025;
        lng += (Math.random()-0.5)*0.0025;
        updates.push(updateDoc(doc(db,'vehicles', v.id), { latitude: lat, longitude: lng, updatedAt: new Date().toISOString() }).catch(()=>{}));
      });
      await Promise.all(updates);
    }

    // --- Ride actions: Assign / Start / Complete / Cancel ---
    async function openAssignModal(rideId){
      // fill select with available vehicles
      assignVehicleSelect.innerHTML = '<option value="">Loading...</option>';
      const snap = await getDocs(collection(db,'vehicles'));
      const opts = [];
      snap.forEach(d => {
        const o = d.data();
        opts.push({ id: d.id, ...o });
      });
      // filter to available & busy (we allow selecting busy if desired)
      assignVehicleSelect.innerHTML = '';
      opts.forEach(v=> {
        const o = document.createElement('option'); o.value = v.id; o.textContent = `${v.name} ‚Äî ${v.type} (${v.status||'unknown'})`;
        assignVehicleSelect.appendChild(o);
      });
      document.getElementById('assignRideId').value = rideId;
      assignModal.show();
    }

    assignForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const rideId = document.getElementById('assignRideId').value;
      const vehicleId = assignVehicleSelect.value;
      if (!vehicleId) return alert('Select a vehicle');
      // set ride to accepted + link vehicle
      const vdoc = await getDoc(doc(db,'vehicles', vehicleId));
      const vdata = vdoc.exists() ? vdoc.data() : null;
      await updateDoc(doc(db,'rides', rideId), { status:'accepted', vehicleId, assignedVehicleName: vdata?.name || null, acceptedAt: new Date().toISOString() });
      // mark vehicle busy
      await updateDoc(doc(db,'vehicles', vehicleId), { status: 'busy', updatedAt: new Date().toISOString() });
      assignModal.hide();
      alert('Assigned vehicle');
    });

    async function startRide(rideId){
      await updateDoc(doc(db,'rides', rideId), { status:'ongoing', startedAt: new Date().toISOString() });
      alert('Ride started');
    }

    async function completeRide(rideId){
      const rDoc = await getDoc(doc(db,'rides', rideId));
      if (!rDoc.exists()) return alert('Ride not found');
      const r = rDoc.data();
      await updateDoc(doc(db,'rides', rideId), { status:'completed', completedAt: new Date().toISOString() });
      // create payment doc and update loyalty
      const amount = r.estimate?.fare || 0;
      const payment = { rideId, amount, customer: r.customerName || r.customerPhone || null, driver: r.assignedVehicleName || null, createdAt: new Date().toISOString() };
      const pRef = await addDoc(collection(db,'payments'), payment);
      // award loyalty (simple: 1 point per 100 KSh)
      const points = Math.floor(amount / 100);
      if (points > 0){
        await addDoc(collection(db,'loyalty'), { phone: r.customerPhone || null, customer: r.customerName || null, points, rideId, createdAt: new Date().toISOString() });
      }
      // set vehicle available again
      if (r.vehicleId) await updateDoc(doc(db,'vehicles', r.vehicleId), { status: 'available', updatedAt: new Date().toISOString() });
      alert('Ride completed, payment recorded and loyalty updated');
      showReceipt({ id: pRef.id, ...payment });
    }

    async function cancelRide(rideId){
      if (!confirm('Cancel ride?')) return;
      await updateDoc(doc(db,'rides', rideId), { status:'cancelled', cancelledAt: new Date().toISOString() });
      alert('Ride cancelled');
    }

    // --- Receipts UI ---
    const receiptModalEl = document.getElementById('receiptModal');
    const receiptModal = new bootstrap.Modal(receiptModalEl);
    function showReceipt(p){
      const html = `<div><h5>RidePro Receipt</h5>
        <div>Receipt #: ${escapeHtml(p.id)}</div>
        <div>Date: ${new Date(p.createdAt).toLocaleString()}</div>
        <div>Customer: ${escapeHtml(p.customer||'Guest')}</div>
        <div>Driver: ${escapeHtml(p.driver||'')}</div><hr/>
        <div><strong>KSh ${Number(p.amount).toLocaleString()}</strong></div></div>`;
      document.getElementById('receiptBody').innerHTML = html;
      receiptModal.show();
      document.getElementById('printReceipt').onclick = ()=> {
        const w = window.open('','_blank','width=600,height=800'); w.document.write(`<html><body>${html}</body></html>`); w.document.close(); setTimeout(()=>w.print(),250);
      };
      document.getElementById('downloadReceipt').onclick = async ()=> {
        const { jsPDF } = window.jspdf;
        const docp = new jsPDF();
        await docp.html(html, { x:20, y:20, width:560 });
        docp.save(`receipt-${p.id}.pdf`);
      };
    }

    // reload
    btnReload.onclick = ()=> { if (vehiclesUnsub) vehiclesUnsub(); if (ridesUnsub) ridesUnsub(); startRealtime(); alert('Reloaded listeners'); };

    // helpers
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
  
</body>
</html>
