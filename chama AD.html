<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ChamaHub — Member Dashboard</title>

<!-- Bootstrap & icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root{
  --bg:#031021;
  --panel:#071826;
  --muted:#8da8b8;
  --accent:#00ffd5;
  --glass: rgba(255,255,255,0.03);
  --card-shadow: 0 12px 40px rgba(2,10,25,0.6);
  --radius:14px;
}
body{
  margin:0;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background: linear-gradient(180deg,#00121a 0%, #021f2f 60%);
  color:#e6f8fb;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  min-height:100vh;
}
.container{max-width:1200px;margin:28px auto}
.card-panel{
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:var(--radius);
  padding:18px;
  box-shadow: var(--card-shadow);
  margin-bottom:18px;
}
.muted{color:var(--muted)}
.kpi{font-weight:700;font-size:1.25rem}
.small-muted{color:var(--muted);font-size:0.9rem}
.input-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#dbefff}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.table thead th{color:var(--muted)}
.member-row:hover{background:rgba(255,255,255,0.02)}
.toast-area{position:fixed;right:18px;bottom:18px;z-index:1200}
@media (max-width:900px){ .container{margin:12px} .topbar{flex-direction:column; gap:10px} }
/* ---------- Modal adjustments ---------- */
.modal-content.card-panel {
  background: rgba(10, 25, 40, 0.95); /* darker but mostly opaque */
  color: #e6f8fb; /* text visible */
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: 0 12px 50px rgba(0, 255, 213, 0.3); /* subtle neon glow */
}

/* Inputs inside modals */
.modal-content.card-panel .form-control,
.modal-content.card-panel .form-select {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(0, 255, 213, 0.5);
  color: #e6f8fb;
}

.modal-content.card-panel .form-control::placeholder,
.modal-content.card-panel .form-select option {
  color: #8da8b8; /* muted placeholder text */
}

/* Buttons inside modals */
.modal-content.card-panel .btn-primary {
  background: var(--accent);
  border: 1px solid var(--accent);
  color: #00121a;
}
.modal-content.card-panel .btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #e6f8fb;
}

/* Success / info messages inside modals */
.modal-content.card-panel .text-success {
  color: #00ffae;
}

.modal-content.card-panel .text-danger {
  color: #ff4d4d;
}

</style>
</head>
<body>

<div class="container">

  <!-- LOGIN MODAL -->
  <div class="modal fade" id="memberLoginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="text-light modal-content card-panel" style="max-width:520px;margin:auto">
        <div class="pb-0 border-0 modal-header">
          <h5 class="modal-title">Member sign in</h5>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <input id="loginEmail" class="form-control input-ghost" placeholder="Email" />
          </div>
          <div class="mb-2">
            <input id="loginPassword" type="password" class="form-control input-ghost" placeholder="Password (set by admin)" />
          </div>
          <div id="loginMsg" class="mb-2 text-danger small"></div>
          <div class="gap-2 d-grid">
            <button id="btnLogin" class="btn btn-primary">Sign in</button>
            <button id="btnLoginDemo" class="btn btn-ghost"></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TOPBAR -->
  <div class="d-flex align-items-center justify-content-between mb-3 topbar">
    <div>
      <h3 class="mb-0">Member Dashboard</h3>
      <div class="small-muted">Your Chama portal — connected to admin</div>
    </div>

    <div class="d-flex align-items-center gap-2">
      <input id="searchAll" class="form-control input-ghost" placeholder="Search members, contributions, loans" style="width:340px">
      <button id="btnRefresh" class="btn btn-ghost"><i class="bi bi-arrow-clockwise"></i></button>
      <button id="btnLogout" class="btn-outline-secondary btn">Logout</button>
    </div>
  </div>

  <!-- OVERVIEW -->
  <div class="mb-3 card-panel">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <div class="muted small">Welcome,</div>
        <h4 id="meName" class="mb-0">Member</h4>
        <div class="small-muted" id="meMeta">Email • Phone</div>
      </div>

      <div class="d-flex align-items-center gap-3">
        <div class="text-center">
          <div class="small-muted">Your total contributions</div>
          <div id="meTotalContrib" class="kpi">KSh 0</div>
        </div>
        <div class="text-center">
          <div class="small-muted">Rotation position</div>
          <div id="meRotation" class="kpi">-</div>
        </div>
        <div class="text-center">
          <div class="small-muted">Next payout</div>
          <div id="meNext" class="kpi muted">-</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTIONS ROW -->
  <div class="d-flex flex-wrap gap-3 mb-3">
    <div class="card-panel" style="flex:1;min-width:280px">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="small-muted">Contributions</div>
        <div>
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addContributionModal"><i class="me-1 bi bi-plus-lg"></i>Add</button>
          <button id="exportContrib" class="ms-1 btn btn-ghost btn-sm"><i class="me-1 bi bi-download"></i>Export CSV</button>
        </div>
      </div>
      <div class="muted small">Submit your contribution; admin will confirm.</div>
    </div>

    <div class="card-panel" style="width:340px">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="small-muted">Loans</div>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#requestLoanModal">Request</button>
      </div>
      <div class="muted small">Request a loan — admin will review.</div>
    </div>
  </div>

  <!-- LISTS -->
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card-panel">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="mb-0">All Members</h6>
          <div class="small-muted">Live list</div>
        </div>
        <div class="table-responsive" style="max-height:420px;overflow:auto">
          <table class="table table-borderless text-light">
            <thead><tr><th>Name</th><th>Share</th><th>Rotation</th><th>Next payout</th></tr></thead>
            <tbody id="tableMembers"><tr><td colspan="4" class="text-center muted">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card-panel">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="mb-0">Scheduled payouts</h6>
          <div class="small-muted">Admin schedules these</div>
        </div>
        <div class="table-responsive" style="max-height:220px;overflow:auto">
          <table class="table table-hover table-sm text-light">
            <thead><tr><th>Scheduled</th><th>Member</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody id="tablePayouts"><tr><td colspan="4" class="text-center muted">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card-panel">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="mb-0">All contributions</h6>
          <div class="small-muted">Pending & confirmed</div>
        </div>
        <div class="table-responsive" style="max-height:300px;overflow:auto">
          <table class="table table-hover table-striped">
            <thead><tr><th>Date</th><th>Member</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody id="tableMyContribs"><tr><td colspan="4" class="text-center muted">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card-panel">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="mb-0">All loans</h6>
          <div class="small-muted">Requests & status</div>
        </div>
        <div class="table-responsive" style="max-height:240px;overflow:auto">
          <table class="table table-sm">
            <thead><tr><th>Date</th><th>Member</th><th>Amount</th><th>Months</th><th>Status</th></tr></thead>
            <tbody id="tableMyLoans"><tr><td colspan="5" class="text-center muted">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-3 text-end">
    <button id="downloadAll" class="btn btn-ghost btn-sm"><i class="me-1 bi bi-file-earmark-arrow-down"></i>Download contributions</button>
  </div>

</div>

<!-- TOASTS -->
<div class="toast-area" id="toastArea"></div>

<!-- ADD CONTRIBUTION MODAL -->
<div class="modal fade" id="addContributionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content card-panel">
      <div class="pb-0 border-0 modal-header">
        <h5 class="modal-title">Add Contribution</h5>
      </div>
      <div class="modal-body">
        <input id="contribAmount" type="number" class="mb-2 form-control input-ghost" placeholder="Amount (KSh)">
        <select id="contribMethod" class="mb-2 form-select input-ghost">
          <option value="M-Pesa">M-Pesa</option>
          <option value="Bank">Bank</option>
        </select>
        <div id="contribMsg" class="mb-2 text-success small"></div>
        <div class="gap-2 d-grid">
          <button id="contribSubmit" class="btn btn-primary">Submit contribution</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REQUEST LOAN MODAL -->
<div class="modal fade" id="requestLoanModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content card-panel">
      <div class="pb-0 border-0 modal-header">
        <h5 class="modal-title">Request Loan</h5>
      </div>
      <div class="modal-body">
        <input id="loanAmount" type="number" class="mb-2 form-control input-ghost" placeholder="Amount (KSh)">
        <input id="loanMonths" type="number" class="mb-2 form-control input-ghost" placeholder="Repayment months">
        <input id="loanInterest" type="number" class="mb-2 form-control input-ghost" placeholder="Interest %">
        <div id="loanMsg" class="mb-2 text-success small"></div>
        <div class="gap-2 d-grid">
          <button id="loanSubmit" class="btn btn-primary">Request loan</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC0avd1EPsYGw9paeuECB8dd781ZPQBAMI",
  authDomain: "transc-eec4c.firebaseapp.com",
  projectId: "transc-eec4c",
  storageBucket: "transc-eec4c.firebasestorage.app",
  messagingSenderId: "3676403115",
  appId: "1:3676403115:web:07a7d387e40282aa614eee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const $ = s => document.querySelector(s);
const loginModal = new bootstrap.Modal(document.getElementById('memberLoginModal'), {backdrop:'static'});
const addContribModal = new bootstrap.Modal(document.getElementById('addContributionModal'));
const requestLoanModal = new bootstrap.Modal(document.getElementById('requestLoanModal'));

let me = null;
let unsubscribers = [];

function showToast(title, body, autoHide = true){
  const id = 't'+Date.now();
  const toastHtml = `<div id="${id}" class="align-items-center mb-2 border-0 text-bg-dark toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        <strong>${title}</strong><div class="small-muted">${body}</div>
      </div>
      <button type="button" class="m-auto me-2 btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div></div>`;
  const area = $('#toastArea');
  area.insertAdjacentHTML('beforeend', toastHtml);
  const toastEl = document.getElementById(id);
  const bsToast = new bootstrap.Toast(toastEl, {delay: 6000});
  bsToast.show();
  if(autoHide){ toastEl.addEventListener('hidden.bs.toast', ()=> toastEl.remove()); }
}

// ---------- Login ----------
$('#btnLogin').addEventListener('click', async ()=>{
  $('#loginMsg').textContent = '';
  const email = $('#loginEmail').value.trim().toLowerCase();
  const password = $('#loginPassword').value.trim();
  if(!email || !password){ $('#loginMsg').textContent = 'Enter email and password'; return; }
  try{
    const q = await db.collection('members').where('email','==',email).limit(1).get();
    if(q.empty){ $('#loginMsg').textContent = 'Member not found'; return; }
    const doc = q.docs[0]; const data = doc.data();
    const stored = data.password || data.phone || '';
    if(stored !== password){ $('#loginMsg').textContent = 'Invalid credentials'; return; }
    me = {id: doc.id, ...data};
    afterLogin();
  }catch(e){ $('#loginMsg').textContent = e.message; }
});
$('#btnLoginDemo').addEventListener('click', async ()=>{
  const snap = await db.collection('members').limit(1).get();
  if(!snap.empty){
    const d = snap.docs[0].data();
    $('#loginEmail').value = d.email || '';
    $('#loginPassword').value = d.password || d.phone || '';
    $('#btnLogin').click();
  }
});

// ---------- After login ----------
function afterLogin(){
  loginModal.hide();
  $('#meName').textContent = me.name || 'Member';
  $('#meMeta').textContent = `${me.email || ''} • ${me.phone || ''}`;
  $('#meRotation').textContent = me.rotationPosition || '-';
  $('#meNext').textContent = me.nextPayout ? new Date(me.nextPayout.seconds*1000).toLocaleDateString() : 'None';

  attachMembersListener();
  attachContributionsListener();
  attachLoansListener();
  attachPayoutsListener();

  const unsubMe = db.collection('members').doc(me.id).onSnapshot(doc=>{
    if(!doc.exists) return;
    const d = doc.data();
    me = {id: doc.id, ...d};
    $('#meRotation').textContent = d.rotationPosition || '-';
    $('#meNext').textContent = d.nextPayout ? new Date(d.nextPayout.seconds*1000).toLocaleDateString() : 'None';
  });
  unsubscribers.push(unsubMe);
}

// ---------- Listeners ----------
function attachMembersListener(){
  const unsub = db.collection('members').orderBy('rotationPosition','asc').onSnapshot(snapshot=>{
    const tbody = $('#tableMembers'); tbody.innerHTML = '';
    snapshot.forEach(doc=>{
      const d = doc.data();
      tbody.insertAdjacentHTML('beforeend', `<tr class="member-row">
        <td>${d.name||''}</td>
        <td>${d.share||0}</td>
        <td>${d.rotationPosition||'-'}</td>
        <td>${d.nextPayout? new Date(d.nextPayout.seconds*1000).toLocaleDateString() : '-'}</td>
      </tr>`);
    });
  });
  unsubscribers.push(unsub);
}

let contribLastSeenMap = {};
function attachContributionsListener(){
  const unsub = db.collection('contributions').orderBy('date','desc').onSnapshot(snapshot=>{
    const tbody = $('#tableMyContribs'); tbody.innerHTML = '';
    let total = 0;
    snapshot.forEach(doc=>{
      const d = doc.data();
      total += Number(d.amount || 0);
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${d.date? new Date(d.date.seconds*1000).toLocaleDateString():''}</td>
        <td>${d.memberName||''}</td>
        <td>KSh ${d.amount||0}</td>
        <td>${d.status||'pending'}</td>
      </tr>`);
      const prev = contribLastSeenMap[doc.id];
      if(prev && prev !== d.status){ showToast('Contribution updated', `Contribution (KSh ${d.amount}) for ${d.memberName} is now "${d.status}"`); }
      contribLastSeenMap[doc.id] = d.status;
    });
    $('#meTotalContrib').textContent = `KSh ${total}`;
  });
  unsubscribers.push(unsub);
}

let loansLastSeen = {};
function attachLoansListener(){
  const unsub = db.collection('loans').orderBy('date','desc').onSnapshot(snapshot=>{
    const tbody = $('#tableMyLoans'); tbody.innerHTML = '';
    snapshot.forEach(doc=>{
      const d = doc.data();
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${d.date? new Date(d.date.seconds*1000).toLocaleDateString():''}</td>
        <td>${d.memberName||''}</td>
        <td>KSh ${d.amount||0}</td>
        <td>${d.months||0}</td>
        <td>${d.status||'pending'}</td>
      </tr>`);
      const prev = loansLastSeen[doc.id];
      if(prev && prev !== d.status){ showToast('Loan status changed', `Loan (KSh ${d.amount}) for ${d.memberName} is now "${d.status}"`); }
      loansLastSeen[doc.id] = d.status;
    });
  });
  unsubscribers.push(unsub);
}

function attachPayoutsListener(){
  const unsub = db.collection('payouts').orderBy('scheduledAt','desc').onSnapshot(snapshot=>{
    const tbody = $('#tablePayouts'); tbody.innerHTML = '';
    snapshot.forEach(doc=>{
      const d = doc.data();
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${d.scheduledAt? new Date(d.scheduledAt.seconds*1000).toLocaleDateString():''}</td>
        <td>${d.memberName||''}</td>
        <td>KSh ${d.amount||0}</td>
        <td>${d.status||''}</td>
      </tr>`);
    });
  });
  unsubscribers.push(unsub);
}

// ---------- Logout ----------
$('#btnLogout').addEventListener('click', ()=>{
  unsubscribers.forEach(fn=>fn()); unsubscribers = [];
  me = null; loginModal.show();
});
 // request loan
    $('#loanSubmit').addEventListener('click', async ()=>{
      const amount = Number($('#loanAmount').value);
      const months = Number($('#loanMonths').value);
      const interest = Number($('#loanInterest').value);
      if(!amount || !months || !interest){ $('#loanMsg').textContent='Enter values'; return; }
      await db.collection('loans').add({
        memberEmail: me.email,
        memberName: me.name,
        amount,
        months,
        interest,
        status: 'pending',
        date: firebase.firestore.Timestamp.now()
      });
      $('#loanMsg').textContent='Requested';
      setTimeout(()=>$('#loanMsg').textContent='', 2500);
      const modalEl = document.getElementById('requestLoanModal'); const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    });
  // add contribution
    $('#contribSubmit').addEventListener('click', async ()=>{
      const amt = Number($('#contribAmount').value);
      const method = $('#contribMethod').value;
      if(!amt){ $('#contribMsg').textContent = 'Enter amount'; return; }
      await db.collection('contributions').add({
        memberEmail: me.email,
        memberName: me.name,
        amount: amt,
        method,
        status: 'pending',
        date: firebase.firestore.Timestamp.now()
      });
      $('#contribMsg').textContent = 'Submitted';
      setTimeout(()=>$('#contribMsg').textContent = '', 2500);
      // close modal
      const modalEl = document.getElementById('addContribModal'); const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();
    });


// ---------- Show login modal on load ----------
document.addEventListener('DOMContentLoaded', ()=> loginModal.show());
</script>
</body>
</html>
