<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RidePro — Customer (Live Vehicles)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="icon" type="image/png" href="img/ridepro.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{--bg:#071226;--card:#0f1720;--accent:#c79a2f;--muted:#9aa6b2}
    body{background:linear-gradient(180deg,#071226,#081826);color:#e7eef6;font-family:Inter,system-ui,Arial;padding:18px}
    .brand{color:var(--accent);font-weight:700}
    .panel{background:rgba(255,255,255,0.03);border-radius:10px;padding:16px}
    .driver-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
    .btn-gold{background:var(--accent);border-color:var(--accent);color:#081019}
    .small-muted{color:var(--muted)}
    #map{height:360px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);position:relative}
    @media (max-width:767px){#map{height:220px}}
    .vehicle-img{width:84px;height:56px;border-radius:6px;object-fit:cover}
    .status-green{background:#2ecc71;color:#04210b;padding:4px 8px;border-radius:6px;font-weight:700}
    .status-orange{background:#f39c12;color:#2d1700;padding:4px 8px;border-radius:6px;font-weight:700}
    .status-gray{background:#95a5a6;color:#07121a;padding:4px 8px;border-radius:6px;font-weight:700}

    .map-spinner { position: absolute; top: 12px; right: 12px; z-index: 999; display: none; align-items: center; gap: 8px; background: rgba(0,0,0,0.55); padding: 8px 10px; border-radius: 8px; color: #fff; font-size: 13px; box-shadow: 0 4px 14px rgba(0,0,0,0.4); }
    .map-spinner.show { display:flex; }
    .clear-btn { margin-left: 6px; }
    .spinner-dot { width:14px; height:14px; border:2px solid rgba(255,255,255,0.25); border-top-color:#fff; border-radius:50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="container">
  <header class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h3 class="mb-0 brand">RidePro</h3>
      <div class="small-muted">Fast, safe rides </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <span id="userEmail" class="small-muted"></span>
      <button id="btnOpenAuth" class="btn-outline-light btn btn-sm d-none">Sign In</button>
    </div>
  </header>

  <div class="row g-3">
    <div class="col-lg-7">
      <div class="mb-3 panel">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            <h5 class="mb-0">Book a Ride</h5>
            <div class="small-muted"></div>
          </div>
          <div>
            <select id="vehicleType" class="form-select-sm form-select">
              <option value="car" selected>Car — Standard (1-2 People)</option>
              <option value="premium">Car — Premium (4 People)</option>
              <option value="bike">Motorbike</option>
              <option value="van">Van Group of 6-8</option>
            </select>
          </div>
        </div>

        <div class="mb-2">
          <label class="form-label small-muted">Pickup</label>
          <input id="pickup" class="form-control" placeholder="Enter pickup location"/>
        </div>
        <div class="mb-2">
          <label class="form-label small-muted">Destination</label>
          <input id="destination" class="form-control" placeholder="Enter destination"/>
        </div>

        <div id="map" class="mb-3">
          <div id="mapSpinner" class="map-spinner" aria-hidden="true">
            <div class="spinner-dot" role="img" aria-label="loading"></div>
            <div class="small-muted">Calculating route…</div>
          </div>
        </div>

        <div class="d-flex align-items-center gap-3">
          <div>
            <div class="small-muted">Distance</div>
            <div id="estDistance" class="fw-bold">—</div>
          </div>
          <div>
            <div class="small-muted">Duration</div>
            <div id="estDuration" class="fw-bold">—</div>
          </div>
          <div>
            <div class="small-muted">Fare</div>
            <div id="estFare" class="h4 brand">KSh 0</div>
          </div>
          <div class="d-flex gap-2 ms-auto">
            <button id="btnEstimate" class="btn-outline-light btn btn-sm">Estimate</button>
            <button id="btnClearRoute" class="clear-btn btn-outline-light btn btn btn-sm" title="Clear route">Clear Route</button>
            <button id="btnProceedPayment" class="btn btn-gold btn-sm">Request a ride</button>
          </div>
        </div>

        <hr/>

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label small-muted">Customer name (optional)</label>
            <input id="custName" class="form-control" placeholder="Full name"/>
          </div>
          <div class="col-md-4">
            <label class="form-label small-muted">Phone for M-Pesa (07XX...)</label>
            <input id="custPhone" class="form-control" placeholder="e.g., 07XXXXXXXX"/>
          </div>
          <div class="col-md-4">
            <label class="form-label small-muted">Promo / Loyalty code</label>
            <input id="promo" class="form-control" placeholder="Optional"/>
          </div>
        </div>
      </div>

      <div class="panel">
        <h6 class="mb-2">Recent Requests</h6>
        <div id="requestsList" class="list-group"></div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="mb-3 panel">
        <h6>Available Vehicles</h6>
        <div class="mt-2" id="vehiclesGrid"></div>
      </div>

      <div class="panel">
        <h6>Loyalty</h6>
        <div id="loyaltyInfo" class="small-muted">Earn points after ride completion. Points reduce fare on next rides.</div>
      </div>
    </div>
  </div>
</div>

<!-- Receipt modal -->
<div class="modal fade" id="receiptModal" tabindex="-1"><div class="modal-dialog modal-md"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Receipt</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="receiptBody"></div><div class="modal-footer"><button id="printReceipt" class="btn-outline-light btn btn-sm">Print</button><button id="downloadReceipt" class="btn btn-gold btn btn-sm">Download PDF</button></div></div></div></div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAOQyp4Y7DmN2SFGR6RVFHcn6gzY-vTdw&libraries=places&callback=initMap"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

// ---------------- CONFIG ----------------
const firebaseConfig = {
  apiKey: "AIzaSyC0avd1EPsYGw9paeuECB8dd781ZPQBAMI",
  authDomain: "transc-eec4c.firebaseapp.com",
  projectId: "transc-eec4c",
  storageBucket: "transc-eec4c.appspot.com",
  messagingSenderId: "3676403115",
  appId: "1:3676403115:web:example"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ---------------- UI ----------------
const pickupInput = document.getElementById('pickup');
const destInput = document.getElementById('destination');
const btnEstimate = document.getElementById('btnEstimate');
const btnClearRoute = document.getElementById('btnClearRoute');
const estDistance = document.getElementById('estDistance');
const estDuration = document.getElementById('estDuration');
const estFare = document.getElementById('estFare');
const vehicleType = document.getElementById('vehicleType');
const mapSpinner = document.getElementById('mapSpinner');
const btnProceedPayment = document.getElementById('btnProceedPayment');
const custName = document.getElementById('custName');
const custPhone = document.getElementById('custPhone');
const promo = document.getElementById('promo');
const requestsList = document.getElementById('requestsList');
const vehiclesGrid = document.getElementById('vehiclesGrid');

let map, directionsService, directionsRenderer, vehicleMarkers = [];

// ---------------- HELPERS ----------------
function showSpinner(show=true){ mapSpinner.classList.toggle('show', show); }
function clearRouteAndEstimates(){ estDistance.textContent='—'; estDuration.textContent='—'; estFare.textContent='KSh 0'; if(directionsRenderer) directionsRenderer.setDirections({ routes: [] }); }
const FARE_RATES={ car:{base:120,perKm:30,perMin:6}, premium:{base:200,perKm:60,perMin:8}, bike:{base:12,perKm:6,perMin:4}, van:{base:200,perKm:35,perMin:7} };
function calcFare(km,mins,type){ const rate = FARE_RATES[type]||FARE_RATES.car; return Math.round(rate.base+km*rate.perKm+mins*rate.perMin); }

// ---------------- MAP ----------------
window.initMap = function(){
  map = new google.maps.Map(document.getElementById('map'), { center:{ lat:-1.286389, lng:36.817223 }, zoom:13, mapTypeControl:false, streetViewControl:false, fullscreenControl:false });
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers:false, polylineOptions:{ strokeColor:'#007bff', strokeWeight:5 } });
  new google.maps.places.Autocomplete(pickupInput);
  new google.maps.places.Autocomplete(destInput);

  pickupInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); btnEstimate.click(); }});
  destInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); btnEstimate.click(); }});
};

// ---------------- ESTIMATE ----------------
btnEstimate.onclick = async ()=>{
  const origin = pickupInput.value.trim();
  const dest = destInput.value.trim();
  if(!origin||!dest) return alert('Enter both pickup and destination.');
  showSpinner(true); btnEstimate.disabled=true; btnClearRoute.disabled=true;

  directionsService.route({ origin, destination: dest, travelMode: google.maps.TravelMode.DRIVING, drivingOptions:{ departureTime:new Date() } }, (result,status)=>{
    showSpinner(false); btnEstimate.disabled=false; btnClearRoute.disabled=false;
    if(status==='OK' && result.routes.length){
      directionsRenderer.setDirections(result);
      const leg = result.routes[0].legs[0];
      const km = leg.distance.value/1000;
      const mins = Math.ceil(leg.duration.value/60);
      const type = vehicleType.value||'car';
      const fare = calcFare(km,mins,type);
      estDistance.textContent = `${km.toFixed(2)} km`;
      estDuration.textContent = `${mins} min`;
      estFare.textContent = `KSh ${fare.toLocaleString()}`;
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(leg.start_location);
      bounds.extend(leg.end_location);
      map.fitBounds(bounds,60);
      window._estimate={ pickupText:origin, destText:dest, km, mins, fare, type };
    } else { alert('Error calculating route: ' + status); clearRouteAndEstimates(); }
  });
};
btnClearRoute.onclick = ()=>{
  clearRouteAndEstimates();
  map.setCenter({ lat:-1.286389, lng:36.817223 });
  map.setZoom(13);
};

// ---------------- VEHICLES ----------------
onSnapshot(collection(db,'vehicles'), snapshot=>{
  vehiclesGrid.innerHTML=''; vehicleMarkers.forEach(m=>m.setMap(null)); vehicleMarkers=[];
  snapshot.forEach(doc=>{
    const v = doc.data();
    const div = document.createElement('div'); div.className='d-flex align-items-center gap-2 mb-2';
    div.innerHTML=`<img class="vehicle-img" src="${v.image||'https://via.placeholder.com/80x56'}"><div><div>${v.name}</div><div class="small-muted">${v.type}</div></div><div class="ms-auto status-${v.status||'gray'}">${v.status||'Idle'}</div>`;
    vehiclesGrid.appendChild(div);

    if(v.location){ 
      const marker = new google.maps.Marker({ position:{ lat:v.location.lat, lng:v.location.lng }, map, title:v.name });
      vehicleMarkers.push(marker);
    }
  });
});

// ---------------- REQUESTS ----------------
onSnapshot(collection(db,'rides'), snapshot=>{
  requestsList.innerHTML='';
  snapshot.forEach(doc=>{
    const r = doc.data();
    const div = document.createElement('div'); div.className='list-group-item bg-transparent d-flex justify-content-between align-items-start border rounded mb-2 p-2 text-light';
    div.innerHTML=`<div><div>${r.pickup} → ${r.destination}</div><div class="small-muted">${r.type} • ${r.fare?`KSh ${r.fare}`:'Pending'}</div></div><div class="status-${r.status||'gray'}">${r.status||'Requested'}</div>`;
    requestsList.appendChild(div);
  });
});

// ---------------- SUBMIT RIDE ----------------
btnProceedPayment.onclick = async ()=>{
  if(!window._estimate) return alert('Please estimate fare first.');
  const name = custName.value.trim()||'Anonymous';
  const phone = custPhone.value.trim();
  if(!phone) return alert('Enter phone for payment.');
  const docRef = await addDoc(collection(db,'rides'),{ pickup:window._estimate.pickupText, destination:window._estimate.destText, km:window._estimate.km, mins:window._estimate.mins, fare:window._estimate.fare, type:window._estimate.type, name, phone, status:'requested', requestedAt:new Date() });
  alert('Ride requested!'); custName.value=''; custPhone.value=''; pickupInput.value=''; destInput.value=''; clearRouteAndEstimates();
};

// ---------------- LOYALTY ----------------
let userPoints = parseInt(localStorage.getItem("loyaltyPoints")||"0");
function updatePointsInfo(){ document.getElementById("loyaltyInfo").innerHTML = `You have <strong>${userPoints}</strong> points.`; }
updatePointsInfo();

</script>
</body>
</html>
