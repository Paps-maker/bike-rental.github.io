<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M-Pesa Agents Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
    .navbar { background: #0A7C2F; }
    .navbar-brand, .nav-link, .navbar-text { color: #fff !important; }
    .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn-mpesa { background: #0A7C2F; color: #fff; }
    .btn-mpesa:hover { background: #06591F; color: #fff; }
    .table th { background: #0A7C2F; color: #fff; }
    .file-upload { position: relative; overflow: hidden; display: inline-block; width: 100%; }
    .file-upload input[type="file"] { position: absolute; opacity: 0; right: 0; top: 0; cursor: pointer; height: 100%; width: 100%; }
    .upload-label { background: #0A7C2F; color: white; padding: 8px 15px; border-radius: 8px; width: 100%; display: block; text-align: center; cursor: pointer; }
    .upload-label:hover { background: #06591F; }
    .file-chosen { margin-top: 4px; font-size: 0.85rem; color: #555; }
  </style>
</head>
<body>

  <!-- ðŸ” Login Page -->
  <div id="loginPage" class="py-5 container" style="max-width:400px; display:none;">
    <div class="p-4 card">
      <h4 class="mb-3 text-center fw-bold">Admin Login</h4>
      <form id="loginForm">
        <input type="email" id="loginEmail" class="mb-3 form-control" placeholder="Email" required>
        <input type="password" id="loginPassword" class="mb-3 form-control" placeholder="Password" required>
        <button type="submit" class="w-100 btn btn-mpesa">Login</button>
      </form>
    </div>
  </div>

  <!-- ðŸ–¥ï¸ Dashboard -->
  <div id="dashboardPage" style="display:none;">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#">Admin Dashboard</a>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-light" onclick="downloadCSV()">â¬‡ Export CSV</button>
          <button class="btn btn-sm btn-light" onclick="downloadPDF()">â¬‡ Export PDF</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>
    </nav>

    <div class="mt-4 container-fluid">
      <div class="row">
        <!-- Client Form -->
        <div class="mb-3 col-lg-4">
          <div class="p-3 card">
            <h5 class="mb-3 fw-bold">Add / Edit Client</h5>
            <form id="clientForm">
              <input type="hidden" id="editId">
              <input class="mb-2 form-control" placeholder="Store Name" name="storeName" required>
              <input class="mb-2 form-control" placeholder="Store No" name="storeNo" required>
              <input class="mb-2 form-control" placeholder="Agent No" name="agentNo" required>
              <input class="mb-2 form-control" placeholder="Till Number" name="tillNumber">
              <input class="mb-2 form-control" placeholder="Physical Location" name="location">
              <input class="mb-2 form-control" placeholder="Sub Agent Section" name="subAgent">
              <input class="mb-2 form-control" placeholder="Full Name" name="fullName" required>
              <input class="mb-2 form-control" placeholder="Contact" name="contact" required>

              <!-- Upload Documents -->
              <label class="form-label fw-bold">Upload Documents</label>
              <div class="mb-3">
                <label class="form-label">ID Copy</label>
                <div class="file-upload">
                  <span class="upload-label">Choose File</span>
                  <input type="file" name="idCopy" accept="image/*,.pdf" onchange="showFileName(this,'idCopyName')">
                </div>
                <div id="idCopyName" class="file-chosen">No file selected</div>
              </div>

              <div class="mb-3">
                <label class="form-label">KRA Certificate</label>
                <div class="file-upload">
                  <span class="upload-label">Choose File</span>
                  <input type="file" name="kraCert" accept="image/*,.pdf" onchange="showFileName(this,'kraCertName')">
                </div>
                <div id="kraCertName" class="file-chosen">No file selected</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Certificate of Good Conduct</label>
                <div class="file-upload">
                  <span class="upload-label">Choose File</span>
                  <input type="file" name="goodConduct" accept="image/*,.pdf" onchange="showFileName(this,'goodConductName')">
                </div>
                <div id="goodConductName" class="file-chosen">No file selected</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Business Permit</label>
                <div class="file-upload">
                  <span class="upload-label">Choose File</span>
                  <input type="file" name="businessPermit" accept="image/*,.pdf" onchange="showFileName(this,'businessPermitName')">
                </div>
                <div id="businessPermitName" class="file-chosen">No file selected</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Shop Picture</label>
                <div class="file-upload">
                  <span class="upload-label">Choose File</span>
                  <input type="file" name="shopPicture" accept="image/*" onchange="showFileName(this,'shopPictureName')">
                </div>
                <div id="shopPictureName" class="file-chosen">No file selected</div>
              </div>

              <button class="mt-2 w-100 btn btn-mpesa">Save Client</button>
            </form>
          </div>
        </div>

        <!-- Clients Table -->
        <div class="col-lg-8">
          <div class="p-3 card">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h5 class="fw-bold">Clients List</h5>
              <input id="searchInput" class="w-50 form-control" placeholder="Search by Store Name or Agent No">
            </div>
            <div class="table-responsive">
              <table class="table table-bordered align-middle">
                <thead>
                  <tr>
                    <th>Store</th>
            
                    <th>Agent No</th>
                    <th>Contact</th>
                    <th>Documents</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="clientsTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC0avd1EPsYGw9paeuECB8dd781ZPQBAMI",
      authDomain: "transc-eec4c.firebaseapp.com",
      projectId: "transc-eec4c",
      storageBucket: "gs://transc-eec4c-storage",
      messagingSenderId: "3676403115",
      appId: "1:3676403115:web:8f176dc82e526ac8614eee",
      measurementId: "G-K5JKH3NGR1"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const loginPage = document.getElementById("loginPage");
    const dashboardPage = document.getElementById("dashboardPage");
    const loginForm = document.getElementById("loginForm");
    const form = document.getElementById("clientForm");
    const table = document.getElementById("clientsTable");
    const searchInput = document.getElementById("searchInput");

    let editMode = false;

    // ðŸ” Auth State
    auth.onAuthStateChanged(user => {
      if (user) {
        loginPage.style.display = "none";
        dashboardPage.style.display = "block";
        loadClients();
      } else {
        loginPage.style.display = "block";
        dashboardPage.style.display = "none";
      }
    });

    // Login
    loginForm.addEventListener("submit", e => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPassword").value;
      auth.signInWithEmailAndPassword(email, pass)
        .catch(err => alert("Login failed: " + err.message));
    });

    function logout() { auth.signOut(); }

    // Show chosen file name
    function showFileName(input, targetId) {
      const fileName = input.files.length > 0 ? input.files[0].name : "No file selected";
      document.getElementById(targetId).textContent = fileName;
    }

    // Save or update client with upload progress
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {};
      [...form.elements].forEach(el => {
        if (el.name && el.type !== 'file') data[el.name] = el.value;
      });

      const docs = ['idCopy','kraCert','goodConduct','businessPermit','shopPicture'];
      const editId = document.getElementById("editId").value;
      let clientRow;

      if (editId) {
        clientRow = document.querySelector(`#clientsTable tr[data-id="${editId}"]`);
        if (clientRow) clientRow.querySelector("td").textContent = "Updating...";
      } else {
        const tempId = "temp_" + Date.now();
        clientRow = document.createElement("tr");
        clientRow.setAttribute("data-id", tempId);
        clientRow.innerHTML = `<td colspan="5" class="text-center fw-bold">Uploading...</td>`;
        table.prepend(clientRow);
      }

      for (const doc of docs) {
        const file = form[doc].files[0];
        if (file) {
          try {
            const storageRef = storage.ref('documents/' + Date.now() + '_' + file.name);
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed', 
              snapshot => {
                const percent = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                if (clientRow) clientRow.querySelector("td").textContent = `${doc} uploading: ${percent.toFixed(0)}%`;
              },
              error => console.error('Upload failed:', error),
              async () => {
                data[doc] = await storageRef.getDownloadURL();
              }
            );

            await uploadTask;
          } catch (err) {
            console.warn(`Skipping ${doc} due to upload error:`, err);
          }
        }
      }

      try {
        if (editId) {
          await db.collection('clients').doc(editId).update(data);
          editMode = false;
        } else {
          await db.collection('clients').add(data);
        }
        
        form.reset();
        document.getElementById("editId").value = "";
        document.querySelectorAll('.file-chosen').forEach(el => el.textContent = "No file selected");

        loadClients();
        alert("Client saved successfully!");
      } catch (err) {
        console.error("Error saving client:", err);
        alert("Failed to save client: " + err.message);
      }
    });

    // Load clients
    async function loadClients() {
      table.innerHTML = '';
      const snap = await db.collection('clients').get();
      snap.forEach(doc => {
        const d = doc.data();
        table.innerHTML += `
          <tr data-id="${doc.id}">
            <td>${d.storeName || ''}</td>
            <td>${d.agentNo || ''}</td>
            <td>${d.contact || ''}</td>
            <td>
              ${d.idCopy ? `<a href="${d.idCopy}" download target="_blank">ID</a> |` : ''}
              ${d.kraCert ? `<a href="${d.kraCert}" download target="_blank">KRA</a> |` : ''}
              ${d.goodConduct ? `<a href="${d.goodConduct}" download target="_blank">Good Conduct</a> |` : ''}
              ${d.businessPermit ? `<a href="${d.businessPermit}" download target="_blank">Permit</a> |` : ''}
              ${d.shopPicture ? `<a href="${d.shopPicture}" download target="_blank">Shop</a>` : ''}
            </td>
            <td>
              <button class="btn btn-sm btn-success" onclick="downloadAllDocs('${doc.id}')">â¬‡ All</button>
              <button class="btn btn-sm btn-primary" onclick="editClient('${doc.id}')">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteClient('${doc.id}')">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    // Edit client
    async function editClient(id) {
      const docRef = await db.collection('clients').doc(id).get();
      const d = docRef.data();
      document.getElementById("editId").value = id;
      [...form.elements].forEach(el => { if (el.name && d[el.name]) el.value = d[el.name]; });
      editMode = true;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Delete client
    async function deleteClient(id) {
      await db.collection('clients').doc(id).delete();
      loadClients();
    }

    // Download all documents for one client
    async function downloadAllDocs(clientId) {
      const docRef = await db.collection('clients').doc(clientId).get();
      const d = docRef.data();

      const files = {
        "ID_Copy": d.idCopy,
        "KRA_Certificate": d.kraCert,
        "Good_Conduct": d.goodConduct,
        "Business_Permit": d.businessPermit,
        "Shop_Picture": d.shopPicture
      };

      const zip = new JSZip();
      let hasFiles = false;

      for (const [name, url] of Object.entries(files)) {
        if (url) {
          try {
            const response = await fetch(url);
            const blob = await response.blob();
            zip.file(name + getFileExtension(url), blob);
            hasFiles = true;
          } catch (err) {
            console.error("Error fetching file:", err);
          }
        }
      }

      if (hasFiles) {
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, `${d.storeName || "client"}_documents.zip`);
      } else {
        alert("No documents available for this client.");
      }
    }

    function getFileExtension(url) {
      const match = url.match(/\.([a-zA-Z0-9]+)(?:\?|$)/);
      return match ? "." + match[1] : ".pdf";
    }

    // CSV Export
    function downloadCSV() {
      let csv = "Store Name,Agent No,Contact\n";
      const rows = document.querySelectorAll("#clientsTable tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        if (cols.length >= 3) {
          const store = cols[0].innerText;
          const agent = cols[1].innerText;
          const contact = cols[2].innerText;
          csv += `"${store}","${agent}","${contact}"\n`;
        }
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "clients_list.csv";
      link.click();
    }

    // PDF Export
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Clients List", 10, 10);
      let y = 20;
      const rows = document.querySelectorAll("#clientsTable tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        if (cols.length >= 3) {
          doc.text(`Store: ${cols[0].innerText} | Agent: ${cols[1].innerText} | Contact: ${cols[2].innerText}`, 10, y);
          y += 10;
        }
      });
      doc.save("clients_list.pdf");
    }

    // Search Filter
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();
      document.querySelectorAll("#clientsTable tr").forEach(row => {
        const store = row.children[0].innerText.toLowerCase();
        const agent = row.children[1].innerText.toLowerCase();
        row.style.display = store.includes(q) || agent.includes(q) ? "" : "none";
      });
    });
  </script>
</body>
</html>
