<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bicycle Rental - Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="icon" href="img/cycling-logo-by-dkm721-brandcrowd.png" type="image/png">
<style>
body { font-family: 'Roboto', sans-serif; background:#f0f0f0; margin:0; padding:20px; }
h1 { text-align:center; color:#2c3e50; margin-bottom:20px; }
#loginForm, #dashboard { max-width:1200px; margin:auto; }
input, textarea, select { padding:8px; margin:5px 0; width:100%; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
button { padding:8px 16px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin:2px; }
button:hover { opacity:0.9; }
.logout-btn { background:#c0392b; color:white; float:right; margin-bottom:10px; }
.table-container { margin-top:20px; overflow-x:auto; }
table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; box-shadow:0 6px 15px rgba(0,0,0,0.1); }
th, td { padding:12px; text-align:center; border-bottom:1px solid #ddd; font-size:0.9em; }
th { background:#27ae60; color:white; }
.start-btn { background:#2980b9; color:white; }
.return-btn { background:#c0392b; color:white; }
.cancel-btn { background:#7f8c8d; color:white; }
.delete-btn { background:#7f8c8d; color:white; }
.timer { font-weight:bold; color:red; }
#addWalkinForm { margin-top:20px; background:#ecf0f1; padding:15px; border-radius:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
#addWalkinForm input, #addWalkinForm textarea, #addWalkinForm select { width:auto; flex:1; min-width:120px; }
#addWalkinForm button { flex:0 0 auto; }
#walkinCostDisplay { width:100%; margin-top:5px; font-weight:bold; }
#logs { margin-top:20px; background:#ecf0f1; padding:15px; border-radius:10px; max-height:200px; overflow-y:auto; }
#searchBar { margin-top:20px; }
.charts { display:flex; flex-wrap:wrap; gap:20px; margin-top:20px; justify-content:center; }
.chart-box { background:white; padding:15px; border-radius:10px; box-shadow:0 6px 15px rgba(0,0,0,0.1); flex:1; min-width:280px; max-width:600px; }
@media(max-width:768px){
  th, td{font-size:0.8em; padding:8px;}
  #addWalkinForm{flex-direction:column; align-items:flex-start;}
  .charts{flex-direction:column;}
}
</style>
</head>
<body>

<!-- Login Form -->
<div id="loginForm">
  <h1>Admin Login</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <h1>ðŸš² Bicycle Rental - Admin Dashboard</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
  <p>Welcome, <span id="adminEmail"></span> ðŸŽ‰</p>

  <!-- Walk-in Customer -->
  <div id="addWalkinForm">
    <input type="text" id="walkinName" placeholder="Customer Name">
    <input type="text" id="walkinPhone" placeholder="Phone Number">
    <select id="walkinBike">
      <option value="">Select Bicycle</option>
      <option value="Mountain Bike">Mountain Bike</option>
      <option value="Road Bike">Road Bike</option>
      <option value="Electric Bike">Electric Bike</option>
    </select>
    <input type="datetime-local" id="walkinStart">
    <input type="number" id="walkinDuration" placeholder="Duration (min)">
    <textarea id="walkinItems" placeholder="Items deposited (comma separated)"></textarea>
    <div id="walkinCostDisplay">Estimated Cost: 0 Ksh</div>
    <button onclick="addWalkinCustomer()">Add Walk-in Customer</button>
  </div>

  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Search by bike or customer..." oninput="renderReservations()">
  </div>

  <div class="table-container">
    <table id="reservationTable">
      <thead>
        <tr>
          <th>Bicycle</th>
          <th>Customer Name</th>
          <th>Phone</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Status</th>
          <th>Total Time (min)</th>
          <th>Extra/Early (min)</th>
          <th>Deposited Items</th>
          <th>Timer</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="charts">
    <div class="chart-box">
      <h3>Most Used Bikes</h3>
      <canvas id="bikeUsageChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Peak Hours</h3>
      <canvas id="peakHoursChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Total Revenue</h3>
      <canvas id="revenueChart"></canvas>
    </div>
  </div>

  <div id="logs">
    <h3>Admin Activity Logs</h3>
    <ul id="logList"></ul>
  </div>
</div>

<!-- Firebase Setup -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB8d4sLlqCZ4bQxlUBEYT3axhz1wbJjHaI",
  authDomain: "bicycle-rental-5ca9f.firebaseapp.com",
  projectId: "bicycle-rental-5ca9f",
  storageBucket: "bicycle-rental-5ca9f.firebasestorage.app",
  messagingSenderId: "244319467774",
  appId: "1:244319467774:web:e2a2c790663ea3e7200daf",
  measurementId: "G-XFS1MNQ15W"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ratePerMinute = 1;
let reservations = [];
let activeTimers = {};
let bikeUsageChart, peakHoursChart, revenueChart;
let lastReservationsJSON = '';

// ----- Auth -----
window.login = async function() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    document.getElementById("loginError").innerText = "";
  } catch (e) {
    document.getElementById("loginError").innerText = e.message;
  }
};

window.logout = async function() {
  await signOut(auth);
};

onAuthStateChanged(auth, async (user) => {
  if(user){
    document.getElementById("loginForm").style.display="none";
    document.getElementById("dashboard").style.display="block";
    document.getElementById("adminEmail").innerText = user.email;
    loadReservationsRealtime();
  } else {
    document.getElementById("loginForm").style.display="block";
    document.getElementById("dashboard").style.display="none";
  }
});

// ----- Load Reservations Realtime -----
function loadReservationsRealtime(){
  const collRef = collection(db,"reservations");
  onSnapshot(collRef, snapshot=>{
    reservations = [];
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      reservations.push({...data, id: docSnap.id});
    });
  });
}

// ----- Walk-in Cost Calculation -----
document.getElementById('walkinDuration').addEventListener('input', ()=>{
  const dur = parseInt(document.getElementById('walkinDuration').value);
  document.getElementById('walkinCostDisplay').innerText = dur>0 ? `Estimated Cost: ${dur*ratePerMinute} Ksh` : 'Estimated Cost: 0 Ksh';
});

// ----- Add Walk-in Customer -----
window.addWalkinCustomer = async function(){
  const name=document.getElementById('walkinName').value.trim();
  const phone=document.getElementById('walkinPhone').value.trim();
  const bike=document.getElementById('walkinBike').value;
  const start=document.getElementById('walkinStart').value;
  const duration=parseInt(document.getElementById('walkinDuration').value);
  const items=document.getElementById('walkinItems').value.split(',').map(i=>i.trim()).filter(i=>i);

  if(!name||!phone||!bike||!start||!duration){ alert('Fill all fields'); return; }

  const startTime = new Date(start);
  const endTime = new Date(startTime.getTime() + duration*60000);

  if(reservations.some(r=>r.bike===bike && !r.cancelled && ((startTime<new Date(r.end))&&(endTime>new Date(r.start))))){
    alert('Bike already reserved at this time'); return;
  }

  const newRes = {
    bike, customerName:name, phone, start:startTime.toISOString(), end:endTime.toISOString(),
    picked:false, returned:false, cancelled:false, depositedItems: items
  };

  const docRef = await addDoc(collection(db,"reservations"), newRes);
  document.getElementById('walkinName').value='';
  document.getElementById('walkinPhone').value='';
  document.getElementById('walkinBike').value='';
  document.getElementById('walkinStart').value='';
  document.getElementById('walkinDuration').value='';
  document.getElementById('walkinItems').value='';
  document.getElementById('walkinCostDisplay').innerText='Estimated Cost: 0 Ksh';
};

// ----- Render Reservations -----
function renderReservations(){
  const tbody = document.querySelector("#reservationTable tbody");
  tbody.innerHTML = '';
  const now = new Date();
  const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';

  reservations.sort((a,b)=>new Date(b.start)-new Date(a.start));

  reservations.forEach((r,index)=>{
    if(searchTerm && !r.bike.toLowerCase().includes(searchTerm) && !r.customerName?.toLowerCase().includes(searchTerm)) return;
    const start = new Date(r.start);
    const end = new Date(r.end);
    const status = r.picked?'Riding':(r.returned?'Returned':(now<start?'Upcoming':'Waiting'));
    const totalTime = r.returnedTime ? Math.floor((new Date(r.returnedTime)-start)/60000) : (r.picked?Math.floor((now-start)/60000):'');
    const rideDuration = Math.floor((end-start)/60000);
    const extraEarly = totalTime ? totalTime-rideDuration : 0;

    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${r.bike}</td>
      <td>${r.customerName||'-'}</td>
      <td>${r.phone||'-'}</td>
      <td>${start.toLocaleString()}</td>
      <td>${end.toLocaleString()}</td>
      <td>${status}</td>
      <td>${totalTime||''}</td>
      <td>${extraEarly>0?`Extra: ${extraEarly}`:(extraEarly<0?`Early: ${-extraEarly}`:'')}</td>
      <td>${r.depositedItems?.join(', ')||''}</td>
      <td id="timer-${index}" class="timer">${r.picked && !r.returned ? totalTime : ''}</td>
      <td>
        <button class="start-btn" onclick="startRide(${index})" ${r.picked||r.returned?'disabled':''}>Start</button>
        <button class="return-btn" onclick="returnBike(${index})" ${!r.picked||r.returned?'disabled':''}>Return</button>
        <button class="cancel-btn" onclick="cancelRide(${index})" ${r.picked||r.returned?'disabled':''}>Cancel</button>
        <button class="delete-btn" onclick="deleteRide(${index})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ----- Ride Actions -----
window.startRide = async function(index){
  const r = reservations[index];
  const now = new Date();
  if(now < new Date(r.start)-600000){ alert('Cannot start ride yet. Max 10 min early.'); return; }
  r.picked=true;
  await updateDoc(doc(db,"reservations",r.id), {picked:true});
};

window.returnBike = async function(index){
  const r = reservations[index];
  if(!r.picked || r.returned){ alert('Cannot return'); return; }
  if(activeTimers[index]) clearInterval(activeTimers[index]);
  const now = new Date();
  r.picked=false; r.returned=true; r.returnedTime=now.toISOString();
  await updateDoc(doc(db,"reservations",r.id), {picked:false, returned:true, returnedTime:r.returnedTime});
};

window.cancelRide = async function(index){
  const r = reservations[index];
  if(r.picked){ alert('Cannot cancel ride that started'); return; }
  r.cancelled=true;
  await updateDoc(doc(db,"reservations",r.id), {cancelled:true});
};

window.deleteRide = async function(index){
  const r = reservations[index];
  await deleteDoc(doc(db,"reservations",r.id));
};

// ----- Timers -----
function updateTimers(){
  const now = new Date();
  reservations.forEach((r,index)=>{
    if(r.picked && !r.returned){
      const startTime = new Date(r.start);
      const elapsed = Math.floor((now - startTime)/60000);
      const timerEl = document.getElementById('timer-'+index);
      if(timerEl) timerEl.innerText = `${elapsed} min`;
    }
  });
}

// ----- Charts -----
function updateCharts(){
  const bikeCounts = {}, hourCounts = {}, bikeRevenue = {};
  const now = new Date();

  reservations.forEach(r=>{
    if(!r.cancelled){
      bikeCounts[r.bike] = (bikeCounts[r.bike]||0)+1;

      const startHour = new Date(r.start).getHours();
      hourCounts[startHour] = (hourCounts[startHour]||0)+1;

      let endTime = r.returnedTime ? new Date(r.returnedTime) : now;
      const duration = Math.floor((endTime - new Date(r.start))/60000);
      bikeRevenue[r.bike] = (bikeRevenue[r.bike]||0) + duration*ratePerMinute;
    }
  });

  // Bike Usage
  const bikeLabels = Object.keys(bikeCounts);
  const bikeData = Object.values(bikeCounts);
  if(bikeUsageChart) bikeUsageChart.destroy();
  bikeUsageChart = new Chart(document.getElementById('bikeUsageChart').getContext('2d'), {
    type:'bar',
    data:{labels: bikeLabels, datasets:[{label:'Usage Count', data: bikeData, backgroundColor:'#27ae60'}]},
    options:{responsive:true, plugins:{legend:{display:false}}}
  });

  // Peak Hours
  const hourLabels12 = Array.from({length:24}, (_,i)=>`${i%12===0?12:i%12} ${i<12?'AM':'PM'}`);
  const hourData = hourLabels12.map((_,i)=> hourCounts[i]||0);
  if(peakHoursChart) peakHoursChart.destroy();
  peakHoursChart = new Chart(document.getElementById('peakHoursChart').getContext('2d'), {
    type:'line',
    data:{labels:hourLabels12, datasets:[{label:'Reservations', data:hourData, borderColor:'#2980b9', fill:false}]},
    options:{responsive:true, plugins:{legend:{display:false}}}
  });

  // Revenue
  const revenueLabels = Object.keys(bikeRevenue);
  const revenueData = Object.values(bikeRevenue);
  if(revenueChart) revenueChart.destroy();
  revenueChart = new Chart(document.getElementById('revenueChart').getContext('2d'), {
    type:'doughnut',
    data:{labels:revenueLabels, datasets:[{data:revenueData, backgroundColor:['#f39c12','#2980b9','#27ae60','#8e44ad','#e74c3c']}]},
    options:{responsive:true, plugins:{legend:{position:'bottom'}}}
  });
}

// ----- Main Loop -----
setInterval(()=>{
  renderReservations();
  updateTimers();

  const currentJSON = JSON.stringify(reservations.map(r=>({picked:r.picked, returned:r.returned, cancelled:r.cancelled, start:r.start, end:r.end, bike:r.bike})));
  if(currentJSON !== lastReservationsJSON){
    updateCharts();
    lastReservationsJSON = currentJSON;
  }
},1000);

</script>
</body>
</html>
