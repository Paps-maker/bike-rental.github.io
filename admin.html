<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bicycle Rental - Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="icon" href="img/cycling-logo-by-dkm721-brandcrowd.png" type="image/png">
<style>
body { font-family: 'Roboto', sans-serif; background:#f0f0f0; margin:0; padding:20px; }
h1 { text-align:center; color:#2c3e50; margin-bottom:20px; }
#loginForm, #dashboard { max-width:1200px; margin:auto; }
input, textarea, select { padding:8px; margin:5px 0; width:100%; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
button { padding:8px 16px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin:2px; }
button:hover { opacity:0.9; }
.logout-btn { background:#c0392b; color:white; float:right; margin-bottom:10px; }
.table-container { margin-top:20px; overflow-x:auto; }
table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; box-shadow:0 6px 15px rgba(0,0,0,0.1); }
th, td { padding:12px; text-align:center; border-bottom:1px solid #ddd; font-size:0.9em; }
th { background:#27ae60; color:white; }
.start-btn { background:#2980b9; color:white; }
.return-btn { background:#c0392b; color:white; }
.edit-btn { background:#f39c12; color:white; }
.cancel-btn { background:#7f8c8d; color:white; }
.delete-btn { background:#7f8c8d; color:white; }
.timer { font-weight:bold; color:red; }
#addWalkinForm { margin-top:20px; background:#ecf0f1; padding:15px; border-radius:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
#addWalkinForm input, #addWalkinForm textarea, #addWalkinForm select { width:auto; flex:1; min-width:120px; }
#addWalkinForm button { flex:0 0 auto; }
#walkinCostDisplay { width:100%; font-weight:bold; }
#logs { margin-top:20px; background:#ecf0f1; padding:15px; border-radius:10px; max-height:200px; overflow-y:auto; }
#searchBar { margin-top:20px; }
.charts { display:flex; flex-wrap:wrap; gap:20px; margin-top:20px; justify-content:center; }
.chart-box { background:white; padding:15px; border-radius:10px; box-shadow:0 6px 15px rgba(0,0,0,0.1); flex:1; min-width:280px; max-width:600px; }

@media(max-width:768px){
  th, td{font-size:0.8em; padding:8px;}
  #addWalkinForm{flex-direction:column; align-items:flex-start;}
  .charts{flex-direction:column;}
}
</style>
</head>
<body>

<!-- Login Form -->
<div id="loginForm">
  <h1>Admin Login</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <h1>ðŸš² Bicycle Rental - Admin Dashboard</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
  <p>Welcome, <span id="adminEmail"></span> ðŸŽ‰</p>

  <!-- Add Walk-in Customer -->
  <div id="addWalkinForm">
    <input type="text" id="walkinName" placeholder="Customer Name">
    <input type="text" id="walkinPhone" placeholder="Phone Number">
    <select id="walkinBike">
      <option value="">Select Bicycle</option>
      <option value="Mountain Bike">Mountain Bike</option>
      <option value="Road Bike">Road Bike</option>
      <option value="Electric Bike">Electric Bike</option>
    </select>
    <input type="datetime-local" id="walkinStart">
    <input type="number" id="walkinDuration" placeholder="Duration (min)">
    <textarea id="walkinItems" placeholder="Items deposited (comma separated)"></textarea>
    <div id="walkinCostDisplay">Estimated Cost: 0 Ksh</div>
    <button onclick="addWalkinCustomer()">Add Walk-in Customer</button>
  </div>

  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Search by bike or customer..." oninput="renderAdminTable()">
  </div>

  <div class="table-container">
    <table id="adminTable">
      <thead>
        <tr>
          <th>Bicycle</th>
          <th>Customer Name</th>
          <th>Phone</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Status</th>
          <th>Total Time</th>
          <th>Extra/Early</th>
          <th>Total Cost</th>
          <th>Deposited Items</th>
          <th>Timer</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="charts">
    <div class="chart-box">
      <h3>Most Used Bikes</h3>
      <canvas id="bikeUsageChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Peak Hours</h3>
      <canvas id="peakHoursChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Total Revenue</h3>
      <canvas id="revenueChart"></canvas>
    </div>
  </div>

  <div id="logs">
    <h3>Admin Activity Logs</h3>
    <ul id="logList"></ul>
  </div>
</div>

<!-- Firebase and Admin Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB8d4sLlqCZ4bQxlUBEYT3axhz1wbJjHaI",
  authDomain: "bicycle-rental-5ca9f.firebaseapp.com",
  projectId: "bicycle-rental-5ca9f",
  storageBucket: "bicycle-rental-5ca9f.firebasestorage.app",
  messagingSenderId: "244319467774",
  appId: "1:244319467774:web:e2a2c790663ea3e7200daf",
  measurementId: "G-XFS1MNQ15W"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ratePerMinute = 1;
let activeTimers = {};
let bikeUsageChart=null, peakHoursChart=null, revenueChart=null;

// Login & Logout
async function login(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  try { await signInWithEmailAndPassword(auth,email,password); document.getElementById('loginError').innerText=''; } 
  catch(e){ document.getElementById('loginError').innerText=e.message; }
}
async function logout(){ await signOut(auth); }

onAuthStateChanged(auth, async (user)=>{
  if(user){
    document.getElementById('loginForm').style.display='none';
    document.getElementById('dashboard').style.display='block';
    document.getElementById('adminEmail').innerText=user.email;
    renderAdminTable();
    renderCharts();
    renderLogs();
  } else {
    document.getElementById('loginForm').style.display='block';
    document.getElementById('dashboard').style.display='none';
  }
});

// Add Walk-in Customer
document.getElementById('walkinDuration').addEventListener('input',()=>{
  const dur = parseInt(document.getElementById('walkinDuration').value);
  document.getElementById('walkinCostDisplay').innerText = dur>0 ? `Estimated Cost: ${dur*ratePerMinute} Ksh` : 'Estimated Cost: 0 Ksh';
});

async function addWalkinCustomer(){
  const name=document.getElementById('walkinName').value.trim();
  const phone=document.getElementById('walkinPhone').value.trim();
  const bike=document.getElementById('walkinBike').value;
  const start=document.getElementById('walkinStart').value;
  const duration=parseInt(document.getElementById('walkinDuration').value);
  const items=document.getElementById('walkinItems').value.split(',').map(i=>i.trim()).filter(i=>i);
  if(!name||!phone||!bike||!start||!duration){ alert('Fill all fields'); return; }

  const startTime = new Date(start);
  const endTime = new Date(startTime.getTime() + duration*60000);

  // Add to Firestore
  await addDoc(collection(db,'reservations'),{
    bike, customerName:name, phone, start:startTime, end:endTime,
    picked:false, returned:false, cancelled:false, depositedItems: items,
    createdBy:auth.currentUser.email
  });

  // Clear form
  document.getElementById('walkinName').value='';
  document.getElementById('walkinPhone').value='';
  document.getElementById('walkinBike').value='';
  document.getElementById('walkinStart').value='';
  document.getElementById('walkinDuration').value='';
  document.getElementById('walkinItems').value='';
  document.getElementById('walkinCostDisplay').innerText='Estimated Cost: 0 Ksh';
  
  renderAdminTable();
  addLog(bike,'added walk-in customer');
}

// Fetch and Render Table
async function renderAdminTable(){
  const searchTerm = document.getElementById('searchInput')?.value.toLowerCase()||'';
  const snapshot = await getDocs(collection(db,'reservations'));
  const tbody = document.querySelector('#adminTable tbody');
  tbody.innerHTML='';
  let index=0;
  snapshot.forEach(docSnap=>{
    const r = docSnap.data();
    if(searchTerm && !r.bike.toLowerCase().includes(searchTerm) && !r.customerName.toLowerCase().includes(searchTerm)) return;

    const start = new Date(r.start.seconds*1000);
    const end = new Date(r.end.seconds*1000);
    const now = new Date();
    const status = r.picked?'Riding':(r.returned?'Returned':(now<start?'Upcoming':'Waiting'));
    const totalTime = r.returnedTime ? Math.floor((r.returnedTime.seconds*1000-start)/60000) : (r.picked?Math.floor((now-start)/60000):'');
    const rideDuration=Math.floor((end-start)/60000);
    const extraEarly=totalTime ? totalTime-rideDuration : 0;
    const totalCost=totalTime ? rideDuration + (extraEarly>0?extraEarly:0) : '';
    
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.bike}</td>
      <td>${r.customerName||'-'}</td>
      <td>${r.phone||'-'}</td>
      <td>${start.toLocaleString()}</td>
      <td>${end.toLocaleString()}</td>
      <td>${status}</td>
      <td>${totalTime||''}</td>
      <td>${extraEarly>0?`Extra: ${extraEarly}`:(extraEarly<0?`Early: ${-extraEarly}`:'')}</td>
      <td>${totalCost||''}</td>
      <td>${r.depositedItems ? r.depositedItems.join(', ') : ''}</td>
      <td id="timer-${index}" class="timer">${r.picked && !r.returned ? totalTime : ''}</td>
      <td>
        <button class="start-btn" onclick="startRide('${docSnap.id}')">Start Ride</button>
        <button class="return-btn" onclick="returnBike('${docSnap.id}')" >Return</button>
      </td>`;
    tbody.appendChild(tr);
    index++;
  });
}

// --- Start Ride ---
async function startRide(id){
  const resRef = doc(db,'reservations',id);
  const rDoc = await resRef.get();
  const r = (await getDoc(resRef)).data();
  await updateDoc(resRef,{picked:true});
  addLog(r.bike,'started');
  startTimer(id);
  renderAdminTable();
}

// --- Return Bike ---
async function returnBike(id){
  const resRef = doc(db,'reservations',id);
  const now = new Date();
  await updateDoc(resRef,{picked:false, returned:true, returnedTime:now});
  addLog('Bike','returned');
  renderAdminTable();
}

// --- Timer ---
function startTimer(id){
  if(activeTimers[id]) clearInterval(activeTimers[id]);
  const timerCell = document.getElementById('timer-'+id);
  activeTimers[id] = setInterval(async ()=>{
    const rDoc = await getDoc(doc(db,'reservations',id));
    if(!rDoc.exists()) return;
    const r = rDoc.data();
    const startTime = new Date(r.start.seconds*1000);
    const now = new Date();
    const elapsedSec = Math.floor((now-startTime)/1000);
    timerCell.innerText = formatTime(elapsedSec);
  },1000);
}

function formatTime(sec){
  const h=Math.floor(sec/3600);
  const m=Math.floor((sec%3600)/60);
  const s=sec%60;
  return `${h>0?h+'h ':''}${m}m ${s}s`;
}

// --- Logs ---
async function addLog(bike,action){
  await addDoc(collection(db,'logs'),{admin:auth.currentUser.email,bike,action,time:new Date()});
  renderLogs();
}
async function renderLogs(){
  const snapshot = await getDocs(collection(db,'logs'));
  const ul=document.getElementById('logList');
  ul.innerHTML='';
  snapshot.forEach(docSnap=>{
    const log = docSnap.data();
    const li=document.createElement('li');
    li.innerText=`[${new Date(log.time.seconds*1000).toLocaleString()}] ${log.admin} ${log.action} ${log.bike}`;
    ul.appendChild(li);
  });
}

// --- Charts ---
async function renderCharts(){
  const snapshot = await getDocs(collection(db,'reservations'));
  const bikeCounts={}, hourCounts={}, revenueByDate={};
  snapshot.forEach(docSnap=>{
    const r=docSnap.data();
    const bike=r.bike; bikeCounts[bike]=(bikeCounts[bike]||0)+1;
    const hour=new Date(r.start.seconds*1000).getHours(); hourCounts[hour]=(hourCounts[hour]||0)+1;
    const duration=Math.floor((new Date(r.end.seconds*1000)-new Date(r.start.seconds*1000))/60000);
    const date=new Date(r.start.seconds*1000).toLocaleDateString();
    revenueByDate[date]=(revenueByDate[date]||0)+duration*ratePerMinute;
  });

  if(bikeUsageChart) bikeUsageChart.destroy();
  bikeUsageChart=new Chart(document.getElementById('bikeUsageChart'),{
    type:'bar',
    data:{labels:Object.keys(bikeCounts), datasets:[{label:'Usage Count', data:Object.values(bikeCounts), backgroundColor:'#27ae60'}]}
  });

  if(peakHoursChart) peakHoursChart.destroy();
  peakHoursChart=new Chart(document.getElementById('peakHoursChart'),{
    type:'line',
    data:{labels:Object.keys(hourCounts), datasets:[{label:'Reservations', data:Object.values(hourCounts), borderColor:'#2980b9', fill:false}]}
  });

  if(revenueChart) revenueChart.destroy();
  revenueChart=new Chart(document.getElementById('revenueChart'),{
    type:'line',
    data:{labels:Object.keys(revenueByDate), datasets:[{label:'Revenue (Ksh)', data:Object.values(revenueByDate), borderColor:'#e67e22', fill:false}]}
  });
}

</script>
</body>
</html>
