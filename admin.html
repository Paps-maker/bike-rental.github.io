<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bicycle Rental - Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="icon" href="img/cycling-logo-by-dkm721-brandcrowd.png" type="image/png">
<style>
body { font-family: 'Roboto', sans-serif; background:#f0f0f0; margin:0; padding:20px; }
h1 { text-align:center; color:#2c3e50; margin-bottom:20px; }
#loginForm, #dashboard { max-width:1200px; margin:auto; }
input, textarea, select { padding:8px; margin:5px 0; width:100%; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
button { padding:8px 16px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; margin:2px; }
button:hover { opacity:0.9; }
.logout-btn { background:#c0392b; color:white; float:right; margin-bottom:10px; }
.table-container { margin-top:20px; overflow-x:auto; }
table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; box-shadow:0 6px 15px rgba(0,0,0,0.1); }
th, td { padding:12px; text-align:center; border-bottom:1px solid #ddd; font-size:0.9em; }
th { background:#27ae60; color:white; }
.start-btn { background:#2980b9; color:white; }
.return-btn { background:#c0392b; color:white; }
.edit-btn { background:#f39c12; color:white; }
.cancel-btn { background:#7f8c8d; color:white; }
.delete-btn { background:#7f8c8d; color:white; }
.timer { font-weight:bold; }
#addWalkinForm { margin-top:20px; background:#ecf0f1; padding:15px; border-radius:10px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
#addWalkinForm input, #addWalkinForm textarea, #addWalkinForm select { width:auto; flex:1; min-width:120px; }
#addWalkinForm button { flex:0 0 auto; }
#walkinCostDisplay { width:100%; margin-top:5px; font-weight:bold; }
#logs { margin-top:20px; background:#ecf0f1; padding:15px; border-radius:10px; max-height:200px; overflow-y:auto; }
#searchBar { margin-top:20px; }
.charts { display:flex; flex-wrap:wrap; gap:20px; margin-top:20px; justify-content:center; }
.chart-box { background:white; padding:15px; border-radius:10px; box-shadow:0 6px 15px rgba(0,0,0,0.1); flex:1; min-width:280px; max-width:600px; }
@media(max-width:768px){
  th, td{font-size:0.8em; padding:8px;}
  #addWalkinForm{flex-direction:column; align-items:flex-start;}
  .charts{flex-direction:column;}
}
</style>
</head>
<body>

<!-- Login Form -->
<div id="loginForm">
  <h1>Admin Login</h1>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <h1>ðŸš² Bicycle Rental - Admin Dashboard</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
  <p>Welcome, <span id="adminEmail"></span> ðŸŽ‰</p>

  <!-- Walk-in Customer -->
  <div id="addWalkinForm">
    <input type="text" id="walkinName" placeholder="Customer Name">
    <input type="text" id="walkinPhone" placeholder="Phone Number">
    <select id="walkinBike">
      <option value="">Select Bicycle</option>
      <option value="Mountain Bike">Hummer</option>
      <option value="Road Bike">precision</option>
      <option value="Electric Bike">Nitro</option>
      <option value="Mountain Bike">Carsia</option>
      <option value="Road Bike">mustony</option>
      <option value="Electric Bike">Slant</option>
      <option value="Mountain Bike">Carrera 1</option>
      <option value="Road Bike">Carrera 2</option>
      <option value="Electric Bike">valier</option>
    </select>
    <input type="datetime-local" id="walkinStart">
    <input type="number" id="walkinDuration" placeholder="Duration (min)">
    <textarea id="walkinItems" placeholder="Items deposited (comma separated)"></textarea>
    <div id="walkinCostDisplay">Estimated Cost: 0 Ksh</div>
    <button onclick="addWalkinCustomer()">Add Walk-in Customer</button>
  </div>

  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Search by bike or customer..." oninput="renderReservations()">
  </div>

  <div class="table-container">
    <table id="reservationTable">
      <thead>
        <tr>
          <th>Bicycle</th>
          <th>Customer Name</th>
          <th>Phone</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Status</th>
          <th>Total Time (min)</th>
          <th>Extra/Early (min)</th>
          <th>Deposited Items</th>
          <th>Timer</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="charts">
    <div class="chart-box">
      <h3>Most Used Bikes</h3>
      <canvas id="bikeUsageChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Peak Hours</h3>
      <canvas id="peakHoursChart"></canvas>
    </div>
    <div class="chart-box">
      <h3>Total Revenue</h3>
      <canvas id="revenueChart"></canvas>
    </div>
  </div>

  <div id="logs">
    <h3>Admin Activity Logs</h3>
    <ul id="logList"></ul>
  </div>
</div>

<!-- Firebase Setup & Dashboard Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB8d4sLlqCZ4bQxlUBEYT3axhz1wbJjHaI",
  authDomain: "bicycle-rental-5ca9f.firebaseapp.com",
  projectId: "bicycle-rental-5ca9f",
  storageBucket: "bicycle-rental-5ca9f.firebasestorage.app",
  messagingSenderId: "244319467774",
  appId: "1:244319467774:web:e2a2c790663ea3e7200daf",
  measurementId: "G-XFS1MNQ15W"
};

// Firebase init
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ratePerMinute = 1;
let reservations = [];

// Login/Logout
window.login = async function() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth, email, password); document.getElementById("loginError").innerText = ""; }
  catch(e){ document.getElementById("loginError").innerText = e.message; }
};
window.logout = async function(){ await signOut(auth); };

// Auth state
onAuthStateChanged(auth, async (user)=>{
  if(user){
    document.getElementById("loginForm").style.display="none";
    document.getElementById("dashboard").style.display="block";
    document.getElementById("adminEmail").innerText = user.email;
    await loadReservations();
    renderReservations();
    startTimersUpdate();
    renderCharts();
  } else {
    document.getElementById("loginForm").style.display="block";
    document.getElementById("dashboard").style.display="none";
  }
});

// Load reservations
async function loadReservations(){
  reservations = [];
  const querySnapshot = await getDocs(collection(db,"reservations"));
  querySnapshot.forEach(docSnap=>{ reservations.push({...docSnap.data(), id:docSnap.id}); });
}

// Walk-in cost
document.getElementById('walkinDuration').addEventListener('input', ()=>{
  const dur = parseInt(document.getElementById('walkinDuration').value);
  document.getElementById('walkinCostDisplay').innerText = dur>0 ? `Estimated Cost: ${dur*ratePerMinute} Ksh` : 'Estimated Cost: 0 Ksh';
});

// Add walk-in
window.addWalkinCustomer = async function(){
  const name=document.getElementById('walkinName').value.trim();
  const phone=document.getElementById('walkinPhone').value.trim();
  const bike=document.getElementById('walkinBike').value;
  const start=document.getElementById('walkinStart').value;
  const duration=parseInt(document.getElementById('walkinDuration').value);
  const items=document.getElementById('walkinItems').value.split(',').map(i=>i.trim()).filter(i=>i);
  if(!name||!phone||!bike||!start||!duration){ alert('Fill all fields'); return; }

  const startTime = new Date(start);
  const endTime = new Date(startTime.getTime()+duration*60000);
  if(reservations.some(r=>r.bike===bike && ((startTime<new Date(r.end))&&(endTime>new Date(r.start))))){
    alert('Bike already reserved at this time'); return;
  }
  const newRes = { bike, customerName:name, phone, start:startTime.toISOString(), end:endTime.toISOString(), picked:false, returned:false, cancelled:false, depositedItems: items };
  const docRef = await addDoc(collection(db,"reservations"), newRes);
  reservations.push({...newRes, id:docRef.id});
  ['walkinName','walkinPhone','walkinBike','walkinStart','walkinDuration','walkinItems'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('walkinCostDisplay').innerText='Estimated Cost: 0 Ksh';
  renderReservations();
  renderCharts();
};

// Render reservations table with dynamic colors
function renderReservations(){
  const tbody = document.querySelector("#reservationTable tbody");
  tbody.innerHTML = '';
  const now = new Date();
  const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';

  reservations.sort((a,b)=>new Date(b.start)-new Date(a.start));

  reservations.forEach((r,index)=>{
    if(searchTerm && !r.bike.toLowerCase().includes(searchTerm) && !r.customerName?.toLowerCase().includes(searchTerm)) return;
    const start = new Date(r.start);
    const end = new Date(r.end);
    const status = r.picked?'Riding':(r.returned?'Returned':(now<start?'Upcoming':'Waiting'));
    const totalTime = r.returnedTime ? Math.floor((new Date(r.returnedTime)-start)/60000) : (r.picked?Math.floor((now-start)/60000):'');
    const rideDuration = Math.floor((end-start)/60000);
    const extraEarly = totalTime ? totalTime-rideDuration : 0;

    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${r.bike}</td>
      <td>${r.customerName||'-'}</td>
      <td>${r.phone||'-'}</td>
      <td>${start.toLocaleString()}</td>
      <td>${end.toLocaleString()}</td>
      <td>${status}</td>
      <td>${totalTime||''}</td>
      <td>${extraEarly>0?`Extra: ${extraEarly}`:(extraEarly<0?`Early: ${-extraEarly}`:'')}</td>
      <td>${r.depositedItems?.join(', ')||''}</td>
      <td id="timer-${index}" class="timer">${r.picked && !r.returned ? totalTime : ''}</td>
      <td>
        <button class="start-btn" onclick="startRide(${index})" ${r.picked||r.returned?'disabled':''}>Start</button>
        <button class="return-btn" onclick="returnBike(${index})" ${!r.picked||r.returned?'disabled':''}>Return</button>
        <button class="cancel-btn" onclick="cancelRide(${index})" ${r.picked||r.returned?'disabled':''}>Cancel</button>
        <button class="delete-btn" onclick="deleteRide(${index})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);

    // Timer colors
    const timerEl = document.getElementById('timer-'+index);
    if(r.picked && !r.returned) timerEl.style.color = totalTime>rideDuration?'red':'green';
    else if(now < start) timerEl.style.color='gray';
    else timerEl.style.color='black';
  });
}

// Ride actions
window.startRide = async function(index){
  const r = reservations[index];
  const now = new Date();
  if(now < new Date(r.start)-600000){ alert('Cannot start ride yet. Max 10 min early.'); return; }
  r.picked=true;
  await updateDoc(doc(db,"reservations",r.id), {picked:true});
  renderReservations();
};
window.returnBike = async function(index){
  const r = reservations[index];
  if(!r.picked || r.returned){ alert('Cannot return'); return; }
  const now = new Date();
  r.picked=false; r.returned=true; r.returnedTime=now.toISOString();
  await updateDoc(doc(db,"reservations",r.id), {picked:false, returned:true, returnedTime:r.returnedTime});
  renderReservations();
  renderCharts();
};
window.cancelRide = async function(index){
  const r = reservations[index];
  if(r.picked){ alert('Cannot cancel ride that started'); return; }
  r.cancelled=true;
  await updateDoc(doc(db,"reservations",r.id), {cancelled:true});
  renderReservations();
};
window.deleteRide = async function(index){
  const r = reservations[index];
  await deleteDoc(doc(db,"reservations",r.id));
  reservations.splice(index,1);
  renderReservations();
  renderCharts();
};

// ----- Timers update every second -----
function startTimersUpdate(){
  setInterval(()=>{ renderReservations(); },1000);
}

// ----- Charts -----
let bikeChart, peakChart, revenueChart;
function renderCharts(){
  const bikeCounts = {};
  const hourCounts = {};
  let revenue = 0;

  reservations.forEach(r=>{
    if(!r.cancelled){
      bikeCounts[r.bike] = (bikeCounts[r.bike]||0)+1;
      const startH = new Date(r.start).getHours();
      hourCounts[startH] = (hourCounts[startH]||0)+1;
      if(r.returnedTime){
        const dur = Math.floor((new Date(r.returnedTime)-new Date(r.start))/60000);
        revenue += dur*ratePerMinute;
      }
    }
  });

  const bikeCtx = document.getElementById('bikeUsageChart').getContext('2d');
  if(bikeChart) bikeChart.destroy();
  bikeChart = new Chart(bikeCtx,{
    type:'bar',
    data:{ labels:Object.keys(bikeCounts), datasets:[{label:'Uses', data:Object.values(bikeCounts), backgroundColor:'rgba(46, 204, 113,0.7)'}] },
    options:{ responsive:true, plugins:{legend:{display:false}} }
  });

  const peakCtx = document.getElementById('peakHoursChart').getContext('2d');
  if(peakChart) peakChart.destroy();
  peakChart = new Chart(peakCtx,{
    type:'line',
    data:{ labels:Object.keys(hourCounts), datasets:[{label:'Reservations', data:Object.values(hourCounts), borderColor:'rgba(52, 152, 219,0.8)', fill:false}] },
    options:{ responsive:true }
  });

  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  if(revenueChart) revenueChart.destroy();
  revenueChart = new Chart(revenueCtx,{
    type:'doughnut',
    data:{ labels:['Revenue'], datasets:[{data:[revenue], backgroundColor:['rgba(241, 196, 15,0.8)']}] },
    options:{ responsive:true, plugins:{legend:{display:true}} }
  });
}
</script>
</body>
</html>
