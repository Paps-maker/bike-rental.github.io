<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register for Tournament</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { padding: 20px; }
    .modal-header { background-color: #f8f9fa; }
  </style>
</head>
<body>

  <div class="container">
    <h2 class="mb-4">Tournament Registration</h2>
    <p>Open your tournament registration link, fill the form below, and submit to register.</p>
    <button class="btn btn-primary" id="openRegisterBtn">Register for Tournament</button>
  </div>

  <!-- Register Player Modal -->
  <div class="modal fade" id="registerPlayerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="registerPlayerForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Register Player / Team</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="regTournamentId">
          <div class="mb-3">
            <label for="regPlayerName" class="form-label">Player / Team Name</label>
            <input type="text" id="regPlayerName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="regPlayerContact" class="form-label">Contact</label>
            <input type="text" id="regPlayerContact" class="form-control" placeholder="Phone or Email" required>
          </div>
          <div class="form-check mb-3">
            <input type="checkbox" id="regPlayerPaid" class="form-check-input">
            <label for="regPlayerPaid" class="form-check-label">Paid</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Register</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

<script>
// Helper for selecting elements
const $ = el => document.querySelector(el);

// Initialize Bootstrap modal
const registerModal = new bootstrap.Modal($('#registerPlayerModal'));

// Auto-open registration modal if 'tid' is in URL
document.addEventListener('DOMContentLoaded', async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const tidFromLink = urlParams.get('tid');

  if (tidFromLink) {
    openRegisterModal(tidFromLink);
  }

  // Optionally render tournaments list if you want users to pick one
  renderTournamentsList();
});

// Function to open the register modal for a given tournament
function openRegisterModal(tid) {
  $('#regTournamentId').value = tid;
  $('#regPlayerName').value = '';
  $('#regPlayerContact').value = '';
  $('#regPlayerPaid').checked = false;

  // Ensure inputs are editable
  $('#regPlayerName').removeAttribute('disabled');
  $('#regPlayerContact').removeAttribute('disabled');

  // Update modal title and button text
  $('#registerPlayerModal .modal-title').textContent = 'Register Player / Team';
  $('#registerPlayerForm button[type="submit"]').textContent = 'Register';

  // Show modal and focus first input
  registerModal.show();
  $('#regPlayerName').focus();
}

// Render tournaments list for users to choose from
async function renderTournamentsList() {
  const wrap = $('#tournamentsList'); // div where tournaments are shown
  if(!wrap) return;
  wrap.innerHTML = '';

  const tournamentsSnap = await db.collection('tournaments').orderBy('date').get();
  tournamentsSnap.forEach(doc => {
    const t = { id: doc.id, ...doc.data() };
    const div = document.createElement('div');
    div.className = 'station-card d-flex justify-content-between align-items-center mb-2 p-2';
    div.innerHTML = `
      <div>
        <strong>${t.name}</strong>
        <div class="small-muted">${t.game || '-'} â€¢ ${t.date || '-'}</div>
        <div class="small-muted">Fee: KSh ${t.fee || 0}</div>
      </div>
      <div class="d-flex flex-column gap-1">
        <button class="btn btn-sm btn-success register-player-btn" data-id="${t.id}">Register</button>
      </div>`;
    wrap.appendChild(div);
  });

  // Attach click for register buttons
  document.querySelectorAll('.register-player-btn').forEach(btn => {
    btn.onclick = () => openRegisterModal(btn.dataset.id);
  });
}

// Register player form submit
document.getElementById('registerPlayerForm').onsubmit = async e => {
  e.preventDefault();

  const tid = $('#regTournamentId').value;
  const name = $('#regPlayerName').value.trim();
  const contact = $('#regPlayerContact').value.trim();
  const paid = $('#regPlayerPaid').checked;

  if (!name) return alert('Please enter your name!');
  if (!contact) return alert('Please enter your email or phone!');

  const tournamentRef = db.collection('tournaments').doc(tid);
  const tournamentSnap = await tournamentRef.get();
  if (!tournamentSnap.exists) return alert('Tournament not found!');

  const tournament = tournamentSnap.data();
  const participants = tournament.participants || [];

  if (participants.some(p => p.contact === contact)) {
    return alert('You are already registered!');
  }

  const participant = { id: uid(), name, contact, paid, timestamp: Date.now() };
  await tournamentRef.update({ participants: firebase.firestore.FieldValue.arrayUnion(participant) });

  registerModal.hide();
  alert('Player / Team registered successfully!');
  renderTournamentsList(); // optional: refresh list
};

// Print receipt (unchanged)
document.addEventListener('click', e => {
  if (e.target.classList.contains('print-receipt-btn')) {
    const tid = e.target.dataset.tid;
    const pid = e.target.dataset.pid;
    const t = state.tournaments[tid];
    const p = (t.participants || []).find(x => x.id === pid);
    if (!p) return alert('Player not found');

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text('Tournament Receipt', 14, 20);
    doc.setFontSize(12);
    doc.text(`Tournament: ${t.name}`, 14, 40);
    doc.text(`Player/Team: ${p.name}`, 14, 50);
    doc.text(`Contact: ${p.contact || '-'}`, 14, 60);
    doc.text(`Entry Fee: KSh ${t.fee || 0}`, 14, 70);
    const startTime = new Date(p.timestamp).toLocaleString();
    const stopTime = new Date().toLocaleString();
    doc.text(`Start Time: ${startTime}`, 14, 80);
    doc.text(`Receipt Time: ${stopTime}`, 14, 90);
    doc.save(`${p.name}_${t.name}_receipt.pdf`);
  }
});

// Export all players PDF (unchanged)
document.getElementById('exportPlayersPdf')?.onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const title = document.getElementById('viewPlayersTitle')?.textContent || 'Players';
  doc.setFontSize(16);
  doc.text(title, 14, 20);

  const rows = [];
  const tbody = document.querySelectorAll('#playersTable tbody tr');
  tbody.forEach(tr => {
    const cols = Array.from(tr.querySelectorAll('td')).slice(0, 3).map(td => td.textContent);
    rows.push(cols);
  });

  doc.autoTable({ head: [['Name', 'Contact', 'Paid']], body: rows, startY: 30 });
  doc.save(`${title.replace(/\s+/g,'_')}_players.pdf`);
};
</script>

</body>
</html>
