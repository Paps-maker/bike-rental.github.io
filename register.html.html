<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Register for Tournament</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">

<div class="py-5 container">
  <h2 class="mb-4 text-center">Tournament Registration</h2>
  <div id="tournamentInfo" class="mb-3 text-center"></div>

  <!-- Register Player Modal -->
  <div class="modal fade" id="registerPlayerModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="p-3 modal-content">
        <h5 class="mb-3 modal-title">Register Player / Team</h5>
        <form id="registerPlayerForm">
          <input type="hidden" id="regTournamentId">
          <div class="mb-3">
            <label for="regPlayerName" class="form-label">Name / Team Name</label>
            <input type="text" id="regPlayerName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="regPlayerContact" class="form-label">Phone / Contact</label>
            <input type="text" id="regPlayerContact" class="form-control" required>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" id="regPlayerPaid" class="form-check-input">
            <label class="form-check-label" for="regPlayerPaid">Paid</label>
          </div>
          <div class="text-end">
            <button type="submit" class="btn btn-primary">Register</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // ---------------- FIREBASE CONFIG ----------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function $(id){ return document.getElementById(id); }

  function uid(){ return '_' + Math.random().toString(36).substr(2, 9); }

  document.addEventListener('DOMContentLoaded', async ()=>{

    const urlParams = new URLSearchParams(window.location.search);
    const tid = urlParams.get('tid');

    if(!tid){
      $('tournamentInfo').innerHTML = '<p class="text-danger">No tournament selected. Please use a valid registration link.</p>';
      return;
    }

    // Fetch tournament details
    const tournamentSnap = await db.collection('tournaments').doc(tid).get();
    if(!tournamentSnap.exists){
      $('tournamentInfo').innerHTML = '<p class="text-danger">Tournament not found!</p>';
      return;
    }

    const t = tournamentSnap.data();
    $('tournamentInfo').innerHTML = `
      <p><strong>${t.name}</strong> - ${t.game || '-'} â€¢ ${t.date || '-'}</p>
      <p>Entry Fee: KSh ${t.fee || 0}</p>
      <button id="btnOpenRegister" class="btn btn-success">Register Now</button>
    `;

    // Pre-fill tournament ID
    $('regTournamentId').value = tid;

    const registerModal = new bootstrap.Modal($('#registerPlayerModal'));

    // Open modal automatically
    registerModal.show();

    $('btnOpenRegister')?.addEventListener('click', ()=>{
      registerModal.show();
    });
  });

  // Register player
  $('registerPlayerForm').onsubmit = async e=>{
    e.preventDefault();
    const tid = $('regTournamentId').value;
    const name = $('regPlayerName').value.trim();
    const contact = $('regPlayerContact').value.trim();
    const paid = $('regPlayerPaid').checked;

    const tournamentRef = db.collection('tournaments').doc(tid);
    const tournamentSnap = await tournamentRef.get();
    if(!tournamentSnap.exists){ alert('Tournament not found!'); return; }

    const tournament = tournamentSnap.data();
    const participants = tournament.participants || [];

    if(participants.some(p=>p.contact===contact)){
      alert('A player with this phone number is already registered!');
      return;
    }

    const participant = { id: uid(), name, contact, paid, timestamp: Date.now() };

    await tournamentRef.update({ participants: firebase.firestore.FieldValue.arrayUnion(participant) });

    bootstrap.Modal.getInstance($('#registerPlayerModal')).hide();
    alert('You have successfully registered!');
    $('regPlayerName').value = '';
    $('regPlayerContact').value = '';
    $('regPlayerPaid').checked = false;
  };
</script>

</body>
</html>
