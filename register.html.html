<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register for Tournament</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { padding: 20px; }
    .modal-header { background-color: #f8f9fa; }
  </style>
</head>
<body>

  <div class="container">
    <h2 class="mb-4">Tournament Registration</h2>
    <p>Open your tournament registration link, fill the form below, and submit to register.</p>
    <button class="btn btn-primary" id="openRegisterBtn">Register for Tournament</button>
  </div>

  <!-- Register Player Modal -->
  <div class="modal fade" id="registerPlayerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="registerPlayerForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Register Player / Team</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="regTournamentId">
          <div class="mb-3">
            <label for="regPlayerName" class="form-label">Player / Team Name</label>
            <input type="text" id="regPlayerName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="regPlayerContact" class="form-label">Contact</label>
            <input type="text" id="regPlayerContact" class="form-control" placeholder="Phone or Email" required>
          </div>
          <div class="form-check mb-3">
            <input type="checkbox" id="regPlayerPaid" class="form-check-input">
            <label for="regPlayerPaid" class="form-check-label">Paid</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Register</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ---------- Firebase Config ----------
    const firebaseConfig = {
      apiKey: "<YOUR_API_KEY>",
      authDomain: "<YOUR_AUTH_DOMAIN>",
      projectId: "<YOUR_PROJECT_ID>",
      storageBucket: "<YOUR_STORAGE_BUCKET>",
      messagingSenderId: "<YOUR_MESSAGING_SENDER_ID>",
      appId: "<YOUR_APP_ID>"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function uid() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    const registerModal = new bootstrap.Modal(document.getElementById('registerPlayerModal'));
    const urlParams = new URLSearchParams(window.location.search);
    const tidFromLink = urlParams.get('tid');

    // Auto-open modal if link has tid
    if (tidFromLink) {
      $('#regTournamentId').value = tidFromLink;
      $('#regPlayerName').value = '';
      $('#regPlayerContact').value = '';
      $('#regPlayerPaid').checked = false;
      registerModal.show();
    }

    // Open modal manually if button clicked
    document.getElementById('openRegisterBtn').onclick = () => {
      $('#regTournamentId').value = tidFromLink || '';
      registerModal.show();
    };

    // Register player form submission
    document.getElementById('registerPlayerForm').onsubmit = async e => {
      e.preventDefault();
      const tid = $('#regTournamentId').value;
      const name = $('#regPlayerName').value.trim();
      const contact = $('#regPlayerContact').value.trim();
      const paid = $('#regPlayerPaid').checked;

      if(!tid) return alert('Tournament ID missing!');

      const tournamentRef = doc(db, 'tournaments', tid);
      const tournamentSnap = await getDoc(tournamentRef);
      if (!tournamentSnap.exists()) return alert('Tournament not found!');

      const tournament = tournamentSnap.data();
      const participants = tournament.participants || [];

      if (participants.some(p => p.contact === contact)) {
        return alert('A player with this contact is already registered!');
      }

      const participant = { id: uid(), name, contact, paid, timestamp: Date.now() };
      await updateDoc(tournamentRef, { participants: arrayUnion(participant) });

      alert('Player / Team registered successfully!');
      registerModal.hide();
    };

    // Simple jQuery-like selector
    function $(id) { return document.getElementById(id); }
  </script>
</body>
</html>
